var Qe=Object.defineProperty;var Ke=(r,t,n)=>t in r?Qe(r,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[t]=n;var O=(r,t,n)=>(Ke(r,typeof t!="symbol"?t+"":t,n),n);import{u as oe,b as Re,j as e,Z as Ze,$ as et,B as y,n as tt,d as b,av as P,a0 as st,m as R,W as H,aw as ze,ax as me,ay as nt,a3 as Q,I as se,aa as ye,a9 as be,az as rt,ai as ot,U as D,aA as it,V as je,aB as De,Y as G,aC as ie,H as lt,S as at,aD as Ee,an as He,aE as We,L as ct,e as dt,f as ht,a1 as ut,g as pt,D as le,a4 as K,aF as Ae,aG as gt,aH as ft,x as xt,aI as mt,ak as yt,aJ as bt,aK as Me,aL as Fe,aM as Ne,ac as ae,ad as ve,ae as Y,af as B,ag as ce,aN as Oe,aO as we,aP as vt,aQ as pe,ab as Te,aR as ge,aS as Pe,aT as jt,aU as St,aV as Lt,aW as wt,aX as Tt,E as fe,aY as Ct,aZ as qt,a_ as Bt,a$ as kt,R as Ce,b0 as $t,G as qe,b1 as Be,b2 as ke,p as _,b3 as It}from"./vendor-mui-LwTDUuqz.js";import{r as S}from"./vendor-react-5UJDq-bj.js";import{a as ne}from"./AudioService-CX4mQyd0.js";import{v as Rt,h as zt,E as Dt}from"./vendor-utils-CywV0fR4.js";import{S as Et,C as Ht,a as Wt,L as At,b as Mt,P as Ft,c as Nt,p as Ot,d as Pt,e as Vt}from"./vendor-charts-Cpg01M45.js";class Yt{constructor(){O(this,"patients",[]);this.initializePatients()}initializePatients(){this.patients=[{id:"patient1",name:"Alex Johnson",description:"Young adult with normal hearing",difficulty:"beginner",hearingLossType:"normal",thresholds:this.generateNormalHearingThresholds()},{id:"patient2",name:"Sarah Miller",description:"Middle-aged with mild high-frequency sensorineural hearing loss",difficulty:"beginner",hearingLossType:"sensorineural",thresholds:this.generateMildHighFrequencyLoss()},{id:"patient3",name:"Robert Chen",description:"Adult with moderate flat conductive hearing loss",difficulty:"intermediate",hearingLossType:"conductive",thresholds:this.generateConductiveLoss()},{id:"patient4",name:"Maria Garcia",description:"Elderly with asymmetrical sensorineural hearing loss",difficulty:"intermediate",hearingLossType:"asymmetrical",thresholds:this.generateAsymmetricalLoss()},{id:"patient5",name:"James Wilson",description:"Adult with mixed hearing loss",difficulty:"advanced",hearingLossType:"mixed",thresholds:this.generateMixedLoss()},{id:"patient6",name:"Eliza Thompson",description:"Child with severe-profound sensorineural hearing loss",difficulty:"advanced",hearingLossType:"sensorineural",thresholds:this.generateSevereProfoundLoss()}]}generateNormalHearingThresholds(){const t=[];return[250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3].forEach(s=>{t.push({frequency:s,hearingLevel:this.getRandomLevel(-10,15),ear:"right",testType:"air",responseStatus:"threshold"}),t.push({frequency:s,hearingLevel:this.getRandomLevel(-10,15),ear:"left",testType:"air",responseStatus:"threshold"})}),[250,500,1e3,2e3,3e3,4e3].forEach(s=>{t.push({frequency:s,hearingLevel:this.getRandomLevel(-10,15),ear:"right",testType:"bone",responseStatus:"threshold"}),t.push({frequency:s,hearingLevel:this.getRandomLevel(-10,15),ear:"left",testType:"bone",responseStatus:"threshold"})}),t}generateMildHighFrequencyLoss(){const t=[];return[250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3].forEach(s=>{let l=10,h=10;s>=2e3&&(l=Math.min(85,10+Math.round((s-1500)/100)),h=Math.min(85,10+Math.round((s-1500)/100))),l=l+this.getRandomLevel(-5,5),h=h+this.getRandomLevel(-5,5),t.push({frequency:s,hearingLevel:l,ear:"right",testType:"air",responseStatus:"threshold"}),t.push({frequency:s,hearingLevel:h,ear:"left",testType:"air",responseStatus:"threshold"})}),[250,500,1e3,2e3,3e3,4e3].forEach(s=>{let l=10,h=10;s>=2e3&&(l=Math.min(85,10+Math.round((s-1500)/100)),h=Math.min(85,10+Math.round((s-1500)/100))),l=l+this.getRandomLevel(-5,5),h=h+this.getRandomLevel(-5,5),t.push({frequency:s,hearingLevel:l,ear:"right",testType:"bone",responseStatus:"threshold"}),t.push({frequency:s,hearingLevel:h,ear:"left",testType:"bone",responseStatus:"threshold"})}),t}generateConductiveLoss(){const t=[];return[250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3].forEach(s=>{const l=40+this.getRandomLevel(0,15),h=40+this.getRandomLevel(0,15);t.push({frequency:s,hearingLevel:l,ear:"right",testType:"air",responseStatus:"threshold"}),t.push({frequency:s,hearingLevel:h,ear:"left",testType:"air",responseStatus:"threshold"})}),[250,500,1e3,2e3,3e3,4e3].forEach(s=>{const l=this.getRandomLevel(-10,15),h=this.getRandomLevel(-10,15);t.push({frequency:s,hearingLevel:l,ear:"right",testType:"bone",responseStatus:"threshold"}),t.push({frequency:s,hearingLevel:h,ear:"left",testType:"bone",responseStatus:"threshold"})}),t}generateAsymmetricalLoss(){const t=[250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3],n=[];return t.forEach(o=>{let s;o<=1e3?s=this.getRandomLevel(15,25):s=this.getRandomLevel(30,45);let l;o<=1e3?l=this.getRandomLevel(40,55):l=this.getRandomLevel(60,75),n.push({frequency:o,hearingLevel:s,ear:"right",testType:"air",responseStatus:"threshold"}),n.push({frequency:o,hearingLevel:l,ear:"left",testType:"air",responseStatus:"threshold"}),o<=4e3&&(n.push({frequency:o,hearingLevel:s,ear:"right",testType:"bone",responseStatus:"threshold"}),n.push({frequency:o,hearingLevel:l,ear:"left",testType:"bone",responseStatus:"threshold"}))}),n}generateMixedLoss(){const t=[250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3],n=[],o=25;return t.forEach(s=>{let l,h;s<=1e3?(l=this.getRandomLevel(20,30),h=this.getRandomLevel(20,30)):(l=this.getRandomLevel(40,55),h=this.getRandomLevel(40,55));const d=l+o,p=h+o;n.push({frequency:s,hearingLevel:d,ear:"right",testType:"air",responseStatus:"threshold"}),n.push({frequency:s,hearingLevel:p,ear:"left",testType:"air",responseStatus:"threshold"}),s<=4e3&&(n.push({frequency:s,hearingLevel:l,ear:"right",testType:"bone",responseStatus:"threshold"}),n.push({frequency:s,hearingLevel:h,ear:"left",testType:"bone",responseStatus:"threshold"}))}),n}generateSevereProfoundLoss(){const t=[250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3],n=[];return t.forEach(o=>{const s=this.getRandomLevel(80,110),l=this.getRandomLevel(80,110);n.push({frequency:o,hearingLevel:s,ear:"right",testType:"air",responseStatus:"threshold"}),n.push({frequency:o,hearingLevel:l,ear:"left",testType:"air",responseStatus:"threshold"}),o<=4e3&&(n.push({frequency:o,hearingLevel:s,ear:"right",testType:"bone",responseStatus:o<=1e3?"threshold":"no_response"}),n.push({frequency:o,hearingLevel:l,ear:"left",testType:"bone",responseStatus:o<=1e3?"threshold":"no_response"}))}),n}getRandomLevel(t,n){t=Math.max(5,t);const o=Math.round((Math.random()*(n-t)+t)/5)*5;return Math.min(120,Math.max(5,o))}getAllPatients(){return[...this.patients]}getPatientById(t){return this.patients.find(n=>n.id===t)}getPatientsByDifficulty(t){return this.patients.filter(n=>n.difficulty===t)}getPatientsByType(t){return this.patients.filter(n=>n.hearingLossType===t)}}const Se=new Yt,Ut={beginner:"success",intermediate:"warning",advanced:"error"},_t={normal:"success",conductive:"info",sensorineural:"warning",mixed:"error",asymmetrical:"secondary"},Jt=r=>r.split(" ").map(t=>t.charAt(0)).join("").toUpperCase(),Xt=({patient:r,onSelect:t,selected:n=!1})=>{const o=oe(),s=Re(o.breakpoints.down("sm"));return e.jsxs(Ze,{elevation:n?8:3,sx:{maxWidth:"100%",transition:"all 0.3s ease",transform:n?"scale(1.02)":"scale(1)",border:n?"2px solid #3f51b5":"none",height:"100%",display:"flex",flexDirection:"column"},children:[e.jsxs(et,{sx:{flexGrow:1,p:{xs:1.5,sm:2}},children:[e.jsxs(y,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},alignItems:{xs:"center",sm:"flex-start"},mb:2},children:[e.jsx(tt,{sx:{bgcolor:n?"#3f51b5":"#9c27b0",width:{xs:48,sm:56},height:{xs:48,sm:56},mr:{xs:0,sm:2},mb:{xs:1,sm:0}},children:Jt(r.name)}),e.jsxs(y,{sx:{width:"100%",textAlign:{xs:"center",sm:"left"}},children:[e.jsx(b,{variant:"h6",component:"div",gutterBottom:!0,children:r.name}),e.jsxs(y,{sx:{display:"flex",gap:1,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"}},children:[e.jsx(P,{label:r.difficulty,size:"small",color:Ut[r.difficulty]}),e.jsx(P,{label:r.hearingLossType.replace("_"," "),size:"small",color:_t[r.hearingLossType]})]})]})]}),e.jsx(b,{variant:"body2",color:"text.secondary",paragraph:!0,sx:{textAlign:{xs:"center",sm:"left"}},children:r.description}),e.jsxs(y,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},justifyContent:"space-between",gap:1},children:[e.jsxs(b,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:"Profile ID:"})," ",r.id]}),e.jsxs(b,{variant:"body2",color:"text.secondary",children:[e.jsx("strong",{children:"Thresholds:"})," ",r.thresholds.length," data points"]})]})]}),e.jsx(st,{sx:{p:{xs:1,sm:1.5}},children:e.jsx(R,{size:s?"medium":"small",variant:n?"contained":"outlined",color:"primary",onClick:()=>t(r),fullWidth:!0,children:n?"Selected":"Select Patient"})})]})};class Gt{constructor(){O(this,"currentSession",null);O(this,"activeSessions",[]);O(this,"completedSessions",[]);O(this,"falsePositiveCount",0);O(this,"testFrequencies",[250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3]);O(this,"boneTestFrequencies",[500,1e3,2e3,4e3]);O(this,"testTypes",["air","bone"]);O(this,"defaultStartLevel",40);O(this,"initialStepSize",10);O(this,"finalStepSize",5);O(this,"includeBoneConduction",!0);O(this,"includeAirConduction",!0)}startSession(t,n){n&&(n.includeAirConduction!==void 0&&(this.includeAirConduction=n.includeAirConduction),n.includeBoneConduction!==void 0&&(this.includeBoneConduction=n.includeBoneConduction));const o=this.generateTestSequence(),s={id:Rt(),startTime:new Date().toISOString(),patientId:t.id,completed:!1,testSequence:o,currentStep:0};return this.currentSession=s,this.activeSessions.push(s),s}generateTestSequence(){const t=[];let n=1;return[{ear:"right",testType:"air"},{ear:"left",testType:"air"},{ear:"right",testType:"bone"},{ear:"left",testType:"bone"}].forEach(({ear:s,testType:l})=>{if(l==="bone"&&!this.includeBoneConduction||l==="air"&&!this.includeAirConduction)return;const h=l==="bone"?this.boneTestFrequencies:this.testFrequencies,d=[],p=h.indexOf(1e3);if(p!==-1){d.push(1e3);for(let v=p+1;v<h.length;v++)d.push(h[v]);d.push(1e3);for(let v=p-1;v>=0;v--)d.push(h[v])}else d.push(...h);d.forEach(v=>{t.push({id:n++,frequency:v,ear:s,testType:l,currentLevel:this.defaultStartLevel,completed:!1,responses:[]})})}),t}getCurrentStep(){if(!this.currentSession)return null;const{currentStep:t,testSequence:n}=this.currentSession;return t>=n.length?null:n[t]}playCurrentTone(t,n=!0){const o=this.getCurrentStep();if(!o)return;const{frequency:s,ear:l,currentLevel:h,testType:d}=o;ne.playTone(s,h,l,t,d,n)}recordResponse(t){if(!this.currentSession)return null;const n=this.getCurrentStep();return n?(n.responses.push({level:n.currentLevel,response:t}),this.adjustLevelPerProtocol(n,t),n):null}recordResponseWithoutAdjustment(t){if(!this.currentSession)return null;const n=this.getCurrentStep();return n?(n.responses.push({level:n.currentLevel,response:t}),n):null}setCurrentLevel(t){if(!this.currentSession)return null;const n=this.getCurrentStep();if(!n)return null;const o=n.frequency,s=n.ear;return console.log(`TestingService: Setting level for frequency ${o}Hz, ${s} ear to ${t}dB`),n.currentLevel=t,n}adjustLevelPerProtocol(t,n){const{responses:o}=t;if(n)t.currentLevel=Math.max(-10,t.currentLevel-10),console.log(`Patient responded: Decreasing by 10 dB to ${t.currentLevel} dB (Hughson-Westlake protocol)`);else{const s=o.length<2,l=s?this.initialStepSize:this.finalStepSize;t.currentLevel=Math.min(120,t.currentLevel+l),console.log(`No response: Increasing by ${l} dB to ${t.currentLevel} dB (${s?"Initial phase":"Bracketing phase"})`)}this.isThresholdEstablished(t)&&(t.completed=!0,this.moveToNextStep())}determineStepSize(t){const{responses:n}=t;return n.length<2?this.initialStepSize:this.finalStepSize}isThresholdEstablished(t){const{responses:n}=t;if(n.length<3)return!1;const o=new Map;n.forEach(h=>{const d=h.level,p=o.get(d)||{total:0,heard:0};p.total+=1,h.response&&(p.heard+=1),o.set(d,p)});let s=!1,l=null;return o.forEach((h,d)=>{h.total>=3&&h.heard>=2&&(!s||l!==null&&d<l)&&(s=!0,l=d,console.log(`Threshold identified at ${d} dB with ${h.heard}/${h.total} responses`))}),s&&console.log(`Final threshold established at ${l} dB`),s}moveToNextStep(){if(!this.currentSession)return;const t=this.getCurrentStep();t&&(console.log(`Completing step at level: ${t.currentLevel}dB before moving to next step`),console.log(`Step completed status: ${t.completed}, responseStatus: ${t.responseStatus||"not set"}`)),this.currentSession.currentStep+=1,this.currentSession.currentStep>=this.currentSession.testSequence.length&&this.completeSession()}skipCurrentStep(t=!1){if(console.log("=== Debug: skipCurrentStep called with markCompleted =",t),!this.currentSession)return console.log("=== Debug: skipCurrentStep - no current session"),null;const n=this.getCurrentStep();if(n){t?(console.log(`Marking step as completed with threshold at: ${n.currentLevel}dB`),n.completed=!0,n.responseStatus||(n.responseStatus="threshold")):console.log("Skipping to next step without marking current step as completed");const o=this.currentSession.currentStep;this.moveToNextStep();const s=this.currentSession.currentStep;console.log(`=== Debug: skipCurrentStep - moved from step ${o} to ${s}`),console.log(`=== Debug: session has ${this.currentSession.testSequence.length} total steps`),console.log(`=== Debug: returning new step with frequency ${this.getCurrentStep()?.frequency||"null"}`)}else console.log("=== Debug: skipCurrentStep - no current step found");return this.getCurrentStep()}completeSession(){if(!this.currentSession)return null;const t=this.currentSession;t.completed=!0;const n=t.patientId,o=Se.getPatientById(n),s=this.calculateResults(t,o?.thresholds||[]);return t.results=s,console.log("Completing test session with results:",{sessionId:t.id,userThresholds:s.userThresholds?.length||0,actualThresholds:s.actualThresholds?.length||0}),this.completedSessions.push(t),this.activeSessions=this.activeSessions.filter(l=>l.id!==t.id),this.currentSession=null,t}calculateResults(t,n=[]){const o=this.extractThresholds(t);let s=0,l=0;o.forEach(p=>{const v=n.find(x=>x.frequency===p.frequency&&x.ear===p.ear&&x.testType===p.testType&&x.responseStatus==="threshold"&&p.responseStatus==="threshold");if(v){const x=Math.abs(p.hearingLevel-v.hearingLevel);x<=5?s+=100-x*5:x<=10?s+=50:s+=25,l++}});const h=l>0?Math.round(s/l):0,d={patientId:t.patientId,timestamp:new Date().toISOString(),userThresholds:o,actualThresholds:n,accuracy:h,testDuration:this.calculateTestDuration(t),technicalErrors:this.identifyTechnicalErrors(t),falsePositives:this.falsePositiveCount};return this.falsePositiveCount=0,d}extractThresholds(t){const n=[];return t.testSequence.forEach(o=>{if(o.completed&&o.responses.length>0){const s=new Map;o.responses.forEach(p=>{const v=p.level,x=s.get(v)||{total:0,heard:0};x.total+=1,p.response&&(x.heard+=1),s.set(v,x)});let l=null,h=1/0;s.forEach((p,v)=>{p.total>=3&&p.heard>=2&&v<h&&(h=v,l=v)});const d=l!==null?l:o.currentLevel;console.log(`Extracting threshold for completed step: ${d}dB (was ${o.currentLevel}dB)`),n.push({frequency:o.frequency,hearingLevel:d,ear:o.ear,testType:o.testType,responseStatus:"threshold"})}else if(o.responses.length>0){console.log(`Extracting threshold data for incomplete step with ${o.responses.length} responses`);const s=new Map;o.responses.forEach(d=>{if(d.response){const p=s.get(d.level)||0;s.set(d.level,p+1)}});let l=null,h=1/0;if(s.forEach((d,p)=>{d>=2&&p<h&&(h=p,l=p)}),l!==null)console.log(`Found valid threshold in incomplete step at: ${l}dB`),n.push({frequency:o.frequency,hearingLevel:l,ear:o.ear,testType:o.testType,responseStatus:"threshold"});else if(o.responses.length>0){const d=Math.max(...o.responses.map(p=>p.level));console.log(`No valid threshold found, using highest level: ${d}dB`),n.push({frequency:o.frequency,hearingLevel:d,ear:o.ear,testType:o.testType,responseStatus:"no_response"})}}else n.push({frequency:o.frequency,hearingLevel:0,ear:o.ear,testType:o.testType,responseStatus:"not_tested"})}),n}calculateTestDuration(t){const n=new Date(t.startTime).getTime(),o=new Date().getTime();return Math.round((o-n)/1e3)}identifyTechnicalErrors(t){const n=[],o=t.testSequence.filter(s=>!s.completed);return o.length>0&&n.push(`Skipped ${o.length} test frequencies`),t.testSequence.forEach(s=>{s.completed&&s.responses.length<3&&n.push(`Insufficient responses for ${s.frequency} Hz in ${s.ear} ear`)}),t.testSequence.forEach(s=>{s.responses.length>0&&s.responses[0].level>60&&n.push(`Starting level too high for ${s.frequency} Hz in ${s.ear} ear`)}),n}getCurrentSession(){return this.currentSession}getActiveSessions(){return[...this.activeSessions]}getCompletedSessions(){return[...this.completedSessions]}getSessionById(t){return this.activeSessions.find(n=>n.id===t)||this.completedSessions.find(n=>n.id===t)||null}clearAllSessions(){this.activeSessions=[],this.completedSessions=[],this.currentSession=null}calculateProgress(){if(!this.currentSession)return 0;const t=this.currentSession.testSequence.length;if(t===0)return 0;const n=this.currentSession.testSequence.filter(s=>s.completed&&s.responseStatus==="threshold").length;console.log("Progress calculation:",{totalSteps:t,completedSteps:n,completedThresholdSteps:this.currentSession.testSequence.filter(s=>s.completed&&s.responseStatus==="threshold").map(s=>({id:s.id,frequency:s.frequency,ear:s.ear,level:s.currentLevel,responseStatus:s.responseStatus})),allCompletedSteps:this.currentSession.testSequence.filter(s=>s.completed).map(s=>({id:s.id,frequency:s.frequency,ear:s.ear,level:s.currentLevel,responseStatus:s.responseStatus||"none"}))});const o=Math.round(n/t*100);return console.log(`Progress: ${n}/${t} steps completed (${o}%)`),o}completeCurrentStep(t){if(!this.currentSession||this.currentSession.currentStep===void 0)return console.error("Cannot complete step: No current session or step"),!1;const n=this.currentSession.currentStep;return n<0||n>=this.currentSession.testSequence.length?(console.error(`Invalid step index: ${n}`),!1):(this.currentSession.testSequence[n].completed=!0,this.currentSession.testSequence[n].responseStatus=t,console.log(`Marked step ${n} as completed with responseStatus='${t}'`),!0)}recordFalsePositive(){this.falsePositiveCount++,console.log(`False positive recorded. Total: ${this.falsePositiveCount}`)}}const z=new Gt,Qt=(r,t)=>{if(!t)return r;const n=JSON.parse(JSON.stringify(r)),o=t.testSequence.filter(s=>s.completed&&s.responseStatus==="threshold");return console.log(`Preserving ${o.length} thresholds from current session:`,o.map(s=>`${s.frequency}Hz ${s.ear} ear at ${s.currentLevel}dB`).join(", ")),o.length>0&&o.forEach(s=>{const l=n.testSequence.findIndex(h=>h.frequency===s.frequency&&h.ear===s.ear&&h.testType===s.testType);l!==-1&&(n.testSequence[l]={...n.testSequence[l],completed:!0,responseStatus:"threshold",currentLevel:s.currentLevel})}),n},$e=(r,t)=>{if(!r)return!1;const n=t.find(h=>h.frequency===r.frequency&&h.ear===r.ear&&h.testType===r.testType);if(!n)return!1;const o=Math.floor(Math.random()*10)-5,s=n.hearingLevel+o,l=Math.max(5,s);return r.currentLevel>=l},Kt=r=>{if(!r)return[];const t=r.testSequence.filter(s=>s.completed&&s.responseStatus==="threshold");console.log(`Extracting thresholds from session - found ${t.length} completed steps with thresholds`),console.log("Completed steps with responseStatus=threshold:",t);const n=new Map;t.forEach(s=>{const l=`${s.frequency}-${s.ear}-${s.testType||"air"}`,h={frequency:s.frequency,hearingLevel:s.currentLevel,ear:s.ear,testType:s.testType||"air",responseStatus:"threshold"};console.log(`Adding threshold: ${s.frequency}Hz, ${s.ear} ear, ${s.currentLevel}dB HL, key=${l}`),n.set(l,h)});const o=Array.from(n.values());return console.log(`Extracted ${o.length} unique thresholds:`,o),o},Zt=(r,t)=>t<2?{isValid:!1,reason:`Need more presentations (currently ${t}, need at least 2)`}:t===2&&r===2?{isValid:!0,reason:"Valid threshold: 2 out of 2 responses"}:t===3&&r>=2?{isValid:!0,reason:"Valid threshold: 2 out of 3 responses"}:t>3&&r>=2?{isValid:!0,reason:`Valid threshold: ${r} out of ${t} responses`}:{isValid:!1,reason:`Invalid threshold: only ${r} out of ${t} responses`},es=(r,t,n,o,s,l,h)=>{if(console.log("🔄 updateTrainerState called with:",{didRespond:r,currentStep:t?{frequency:t.frequency,ear:t.ear,currentLevel:t.currentLevel}:null,procedurePhase:n,thresholdPhaseStartTime:s,lastPresentationTime:l,lastProcessedPresentation:h}),!t)return console.warn("❌ Cannot update trainer state: currentStep is null"),{procedurePhase:n,suggestedAction:"present",guidance:"Error: No current test step available. Please restart the test.",lastResponseLevel:null,responseCounts:o};if(l<=h)return console.warn("⚠️ Duplicate presentation detected:",{lastPresentationTime:l,lastProcessedPresentation:h,timeDiff:l-h}),{procedurePhase:n,suggestedAction:"present",guidance:"Please wait before presenting the next tone.",lastResponseLevel:null,responseCounts:o};if(n==="threshold"&&(!s||l<=s))return console.warn("⚠️ Invalid threshold phase timing:",{thresholdPhaseStartTime:s,lastPresentationTime:l,timeDiff:l-(s||0)}),{procedurePhase:n,suggestedAction:"present",guidance:"Please wait a moment before continuing the test.",lastResponseLevel:null,responseCounts:o};let d=JSON.parse(JSON.stringify(o)),p=n,v="present",x="",k=null;const{frequency:L,ear:w,currentLevel:m}=t;if(d[L]||(d[L]={}),d[L][w]||(d[L][w]={}),d[L][w][m]||(d[L][w][m]={total:0,heard:0}),console.log("📊 Current state before processing:",{frequency:L,ear:w,currentLevel:m,currentResponses:d[L][w][m],phase:n}),r){if(console.log("Patient responded - updating state"),n==="initial")p="descending",v="decrease",x=`Good! The patient heard the initial tone at ${m} dB. Following Hughson-Westlake protocol, we'll now begin the descending phase. Decrease by 10 dB and present the tone again. We'll continue decreasing by 10 dB until the patient no longer responds.
      
      Note: Responses during the initial descent do not count towards threshold determination.`,console.log("Initial phase - patient responded, changing to descending phase");else if(n==="descending")p="descending",v="decrease",x=`The patient can still hear at ${m} dB. Continue the descending phase by decreasing in 10 dB steps. This helps us quickly find the approximate threshold region. Once the patient stops responding, we'll begin the more precise bracketing pattern.
      
      Note: Responses during the descending phase are only used to find the approximate threshold region and do not count towards threshold determination.`,console.log("Descending phase - patient responded, suggesting continue decreasing (response not counted for threshold)");else if(n==="ascending")p="threshold",k=m,v="decrease",x=`You've found a potential threshold region at ${m} dB! Now we'll begin the precise bracketing pattern to determine the exact threshold. The Hughson-Westlake protocol requires:
      1. Decrease by 10 dB after EVERY response
      2. Increase by 5 dB when there's NO response
      3. Establish threshold when patient responds to 2 out of 2 or 2 out of 3 presentations at the same level
      
      Note: This first ascending response is used only to identify the threshold region and does not count towards threshold determination.
      Let's start by decreasing 10 dB.`,console.log(`Ascending phase - patient responded at ${m}dB, changed to threshold phase without counting response`),d[L][w][m]&&(d[L][w][m]={total:0,heard:0});else if(n==="threshold"){const u=t.currentLevel,i=t.frequency,a=t.ear;d[i]||(d[i]={}),d[i][a]||(d[i][a]={}),d[i][a][u]||(d[i][a][u]={total:0,heard:0}),d[i][a][u].total+=1,d[i][a][u].heard+=1,console.log(`Threshold phase - adding response at ${u}dB for ${i}Hz, ${a} ear: ${d[i][a][u].heard}/${d[i][a][u].total} responses`),k=u;const c=d[i][a][u].heard,f=d[i][a][u].total;if(s&&l>s)if(console.log(`🔢 Current responses at ${u}dB: ${c}/${f}`),console.log(`⏰ Presentation time: ${l}, Threshold phase start: ${s}`),l>h){v="decrease";const g=Zt(c,f);g.isValid?(console.log(`✅ Threshold CONFIRMED at ${u}dB - ${g.reason}`),p="complete",v="store_threshold",x=`Excellent! You have established a valid threshold at ${u} dB. ${g.reason}. 
            
            This threshold was determined using proper Hughson-Westlake bracketing:
            • Started with descending 10 dB steps
            • Used 5 dB ascending steps
            • Confirmed with ${c}/${f} responses at this level
            
            You can now store this threshold and move to the next test frequency.`):(console.log(`⏳ Continuing threshold testing at ${u}dB - ${g.reason}`),v="decrease",x=`The patient responded at ${u} dB, but we haven't established a threshold yet. ${g.reason}. 
            
            Remember the Hughson-Westlake rules:
            • ALWAYS decrease by 10 dB after a response
            • Need 2 out of 2 or 2 out of 3 responses at the same level
            • Responses must be during the bracketing phase
            
            Following protocol, decrease by 10 dB and continue the bracketing pattern.`)}else console.log(`⚠️ Double counting prevented! This presentation (${l}) was already processed.`);else console.log("⚠️ Ignoring response from before threshold phase started in updateTrainerState"),console.log(`⏰ Presentation time: ${l}, Threshold phase start: ${s}`)}}else{console.log("Patient did NOT respond - updating state");const u=t.currentLevel,i=t.frequency,a=t.ear;switch(d[i]||(d[i]={}),d[i][a]||(d[i][a]={}),d[i][a][u]||(d[i][a][u]={total:0,heard:0}),n==="threshold"?(d[i][a][u].total+=1,console.log(`Threshold phase - adding no-response at ${u}dB for ${i}Hz, ${a} ear: ${d[i][a][u].heard}/${d[i][a][u].total} responses`)):console.log(`${n} phase - not counting no-response towards threshold determination`),n){case"initial":v="increase",x=`No response at ${u} dB. Since this is the initial presentation and we need to find a clearly audible starting level, increase by 10 dB. We'll continue increasing until we get a response, then begin the descending phase.`;break;case"descending":p="ascending",v="increase",x=`No response at ${u} dB - this means we've descended below the threshold region. Now we'll begin the ascending phase:
        1. First, increase by 5 dB (smaller steps for more accuracy)
        2. Continue ascending until patient responds
        3. That first ascending response will mark the start of threshold determination`;break;case"threshold":v="increase",x=`No response at ${u} dB. Following Hughson-Westlake protocol, increase by 5 dB. Remember:
        • Use 5 dB steps when going up
        • Use 10 dB steps when going down
        • This bracketing pattern helps us precisely determine the threshold`;break;default:v="present",x=`No response at ${u} dB.`}}return{procedurePhase:p,suggestedAction:v,guidance:x,lastResponseLevel:k,responseCounts:d}};function ts({currentStep:r,toneActive:t,setToneActive:n,patientResponse:o,setPatientResponse:s,setShowResponseIndicator:l,setPatientJustResponded:h,lastPresentationTimeRef:d,lastProcessedPresentationRef:p,thresholdPhaseStartTime:v,updateTrainerState:x,patientThresholds:k}){const L=S.useCallback(()=>{if(r)try{if(console.log("🎵 Starting tone..."),ne.stopTone(),r){const i=r.frequency;console.log(`🔊 Explicit frequency check: Using ${i}Hz for tone`),z.setCurrentLevel(r.currentLevel),console.log(`🔊 Starting tone at user-set level: ${r.currentLevel}dB`)}s(null),h(!1),l(!1),console.log("🔄 Response states reset"),n(!0),console.log("🔊 Tone active set to true"),z.playCurrentTone(),console.log("🎵 Pulsed tone started");const u=$e(r,k);console.log("👂 Immediate patient response check:",u),u&&(s(u),l(!0),h(!0),console.log("👂 Patient IMMEDIATELY responded to the tone!"),console.log("💾 Recording immediate response for later processing"),z.recordResponseWithoutAdjustment(u)),console.log("🎯 Recording tone presentation time"),d.current=Date.now()}catch(u){console.error("❌ Error playing tone:",u),n(!1),ne.stopTone()}},[r,n,s,l,h,d,k]),w=S.useCallback(()=>{console.log("🛑 Stopping tone..."),ne.stopTone();const u=t,i=o;console.log("🛑 Stopping tone with current state:",{toneActive:u,patientResponse:i}),n(!1);const a=Date.now();d.current=a,console.log("⏱️ Presentation stopped at:",a);let c=i;if(c===null){const f=$e(r,k);console.log("🔊 Simulating patient response at tone stop for internal processing only:",f),c=f}else console.log("🔊 Using existing patient response from during tone playback:",c);r&&(a>p.current?(console.log(`✅ Processing new presentation. Current: ${a}, Last processed: ${p.current}`),c!==null?(z.recordResponseWithoutAdjustment(!!c),console.log("🔄 Immediately updating trainer state with response:",c),x(!!c),p.current=a):(console.log("⚠️ Checking for unprocessed patient response from during tone playback"),i!==null&&(console.log("✅ Found unprocessed patient response:",i),z.recordResponseWithoutAdjustment(!!i),x(!!i),p.current=a))):console.log(`⚠️ Presentation already processed in stopTone! Current: ${a}, Last processed: ${p.current}`)),s(null),l(!1),h(!1),console.log("🔄 Patient response visuals reset AFTER updating trainer state")},[t,o,r,n,s,l,h,d,p,x,k]),m=S.useCallback(()=>{if(console.log("👂 Patient response handler called."),!r){console.log("⚠️ No current step available, cannot process patient response");return}if(!t){console.log("⚠️ False positive detected: Patient responded when no tone was presented"),z.recordFalsePositive(),h(!0),l(!0),setTimeout(()=>{l(!1),h(!1)},500);return}s(!0),l(!0),h(!0),z.recordResponse(!0),console.log("🎯 User indicated POSITIVE response"),x(!0),p.current=d.current,ne.stopTone(),n(!1)},[r,t,s,l,h,x,p,d]);return{startTone:L,stopTone:w,handlePatientResponse:m}}function ss({currentStep:r,session:t,setCurrentStep:n,setSession:o,procedurePhase:s,setProcedurePhase:l,setSuggestedAction:h,setCurrentGuidance:d,setLastResponseLevel:p,preserveThresholds:v}){const x=S.useCallback(w=>{if(r)try{const m=Math.max(-10,Math.min(120,r.currentLevel+w));console.log(`Adjusting level for frequency ${r.frequency}Hz, ${r.ear} ear: ${r.currentLevel}dB -> ${m}dB`),s==="initial"||s==="descending"?w===-10?(l("descending"),h("present"),d(`You've decreased by 10 dB. Now present the tone to see if the patient can still hear it at ${m} dB.`)):w===5||w===10?(h("present"),d(`You've increased by ${w} dB. Present the tone to check for a response at ${m} dB.`)):w===-5&&(h("present"),d(`You've decreased by 5 dB. While Hughson-Westlake protocol uses 10 dB decrements in the descending phase, you can still present the tone at ${m} dB to check for a response.`)):s==="ascending"?w===5?(h("present"),d(`You've increased by 5 dB. Now present the tone to see if the patient can hear it at ${m} dB.`)):w===10?(h("present"),d(`You've increased by 10 dB. While Hughson-Westlake protocol uses 5 dB increments in the ascending phase, you can still present the tone at ${m} dB to check for a response.`)):w<0&&(l("descending"),h("present"),d(`You've decreased by ${Math.abs(w)} dB, changing to the descending phase. Present the tone to check for a response at ${m} dB.`)):s==="threshold"?(w===-10?(h("present"),d(`You've decreased by 10 dB to ${m} dB. This follows the Hughson-Westlake protocol. Present the tone to check for a response at this new level.`),console.log(`Threshold phase - decreased by 10dB to ${m}dB`)):w===5?(h("present"),d(`You've increased by 5 dB to ${m} dB. This follows the Hughson-Westlake protocol. Present the tone to check for a response at this new level.`),console.log(`Threshold phase - increased by 5dB to ${m}dB`)):(h("present"),d(`You've changed the level to ${m} dB. Present the tone to check for a response at this level.`),console.log(`Threshold phase - adjusted by ${w}dB to ${m}dB (non-standard adjustment)`)),p(m)):s==="complete"&&(l("threshold"),h("present"),d(`You're adjusting the level after completing threshold determination. You're now at ${m} dB. Present the tone to check for a response.`));const u={...r,currentLevel:m};if(n(u),z.setCurrentLevel(m),t){const i={...t};i.testSequence=[...i.testSequence];const a=i.currentStep;i.testSequence[a]&&i.testSequence[a].frequency===r.frequency&&i.testSequence[a].ear===r.ear&&(i.testSequence[a]={...i.testSequence[a],currentLevel:m},o(i))}}catch(m){console.error("Error adjusting level:",m)}},[r,t,s,n,o,l,h,d,p]),k=S.useCallback(w=>{if(!r)return;const m=[250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3],u=r.frequency,i=m.indexOf(u);if(i===-1)return;let a=i+w;if(a<0&&(a=0),a>=m.length&&(a=m.length-1),a!==i){const c=m[a];if(console.log(`Changing frequency from ${u}Hz to ${c}Hz`),t){const f=t.testSequence.findIndex(g=>g.frequency===c&&g.ear===r.ear&&g.testType===r.testType);if(f!==-1){console.log(`Found matching step for ${c}Hz at index ${f}`);const g=JSON.parse(JSON.stringify(t));g.currentStep=f;const j=g.testSequence[f];console.log(`Navigating to step with ID ${j.id}, frequency ${j.frequency}Hz`),o(g);const $=JSON.parse(JSON.stringify(j));n($);const C=z.getCurrentSession();C&&(C.currentStep=g.currentStep,console.log(`Explicitly updated TestingService step to ${g.currentStep} with frequency ${j.frequency}Hz`)),j.completed&&j.responseStatus==="threshold"?(l("complete"),h("next"),d(`This frequency already has a threshold stored at ${j.currentLevel} dB. You can proceed to the next frequency or adjust the level to retest.`)):(l("initial"),h("present"),d(`Now testing at ${c} Hz. Begin at a comfortable level (30-40 dB).`))}}}},[r,t,n,o,l,h,d]),L=S.useCallback((w,m)=>{if(!r||!t)return;const i=[250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3].reduce((a,c)=>Math.abs(c-w)<Math.abs(a-w)?c:a);console.log(`Audiogram click - requested: ${w}Hz at ${m}dB, closest available: ${i}Hz`);try{const a=Math.max(-10,Math.min(120,m));if(i!==r.frequency||a!==r.currentLevel){const c=t.testSequence.findIndex(f=>f.frequency===i&&f.ear===r.ear&&f.testType===r.testType);if(c!==-1){const f={...t.testSequence[c]};f.currentLevel=a;const g=z.getCurrentSession();g&&(g.currentStep=c),z.setCurrentLevel(a),n(f);const j={...t};j.currentStep=c,j.testSequence=[...j.testSequence],j.testSequence[c]=f;const $=v(j);o($),f.completed&&f.responseStatus==="threshold"?(l("complete"),h("next"),d(`This frequency already has a threshold stored at ${f.currentLevel} dB. You can proceed to the next frequency or adjust the level to retest.`)):(l("initial"),h("present"),d(`Now testing at ${i} Hz and ${a} dB. Present the tone to check for response.`)),console.log(`Audiogram click - changed to ${i}Hz at ${a}dB`)}else console.error(`Could not find matching step for frequency ${i}Hz in test sequence`)}}catch(a){console.error("Error handling audiogram click:",a)}},[r,t,n,o,l,h,d,v]);return{handleAdjustLevel:x,handleAdjustFrequency:k,handleAudiogramClick:L}}function ns({currentStep:r,session:t,responseCounts:n,setSession:o,setCurrentStep:s,setProcedurePhase:l,setSuggestedAction:h,setCurrentGuidance:d,setResponseCounts:p,setErrorMessage:v}){const x=S.useCallback(()=>{if(!r)return{isValid:!1,message:"No current test step available."};const w=r.frequency,m=r.ear,u=r.currentLevel;if(n&&n[w]&&n[w][m]&&n[w][m][u]){const i=n[w][m][u].heard,a=n[w][m][u].total;return a>=2&&i>=2?{isValid:!0,message:"Valid threshold established."}:a<2?{isValid:!1,message:`Need more responses at this level (${i}/${a} so far).`}:{isValid:!1,message:"Invalid threshold. Hughson-Westlake requires at least 2 out of 3 responses at the same level."}}else return{isValid:!1,message:"No response data available for this level."}},[r,n]),k=S.useCallback(()=>x().isValid,[x]),L=S.useCallback(()=>{if(!r){console.error("Cannot store threshold: no current step");return}const w=x();if(!w.isValid){v(w.message);return}let m=null,u=1/0;const a=n[r.frequency]?.[r.ear]||{};if(Object.entries(a).forEach(([f,g])=>{const j=parseInt(f);g.total>=2&&g.heard>=2&&j<u&&(m=j,u=j)}),m===null){v("Could not determine a valid threshold level.");return}if(console.log(`Storing threshold at validated level: ${m}dB (current level is ${r.currentLevel}dB)`),z.setCurrentLevel(m),z.completeCurrentStep("threshold"),t){const f={...t},g=f.testSequence.findIndex($=>$.frequency===r.frequency&&$.ear===r.ear&&$.testType===r.testType);if(g===-1){console.error("Could not find matching test step in session for frequency:",r.frequency,"ear:",r.ear),v("Failed to store threshold: test step not found.");return}const j=f.testSequence[g];if(j.completed=!0,j.responseStatus="threshold",j.currentLevel=m,console.log(`DEBUG: Storing threshold for step ${g}:`,{id:j.id,frequency:j.frequency,ear:j.ear,currentLevel:j.currentLevel,responseStatus:j.responseStatus}),o(f),r){const $={...r,completed:!0,responseStatus:"threshold",currentLevel:m};s($)}console.log(`Threshold stored at ${m}dB, marked as completed but staying on current frequency`)}const c=z.calculateProgress();console.log(`Updated progress after storing threshold: ${c}%`),d(`Threshold successfully stored at ${m} dB! You can now use the up arrow (or press Up) to move to the next frequency, or the down arrow to go to a previous frequency.`),l("complete"),h("next"),p(f=>{const g={...f},j=m,$=r.frequency,C=r.ear;return console.log(`Updating response counts for threshold: ${$}Hz, ${C} ear at ${j}dB`),g[$]||(g[$]={}),g[$][C]||(g[$][C]={}),g[$][C][j]={total:3,heard:2},g})},[r,t,n,x,v,o,s,d,l,h,p]);return{validateThreshold:x,canStoreThreshold:k,handleStoreThreshold:L}}function rs({session:r,setSession:t,setCurrentStep:n,setProcedurePhase:o,setSuggestedAction:s,setCurrentGuidance:l,setLastResponseLevel:h,setErrorMessage:d,setTestProgress:p,preserveThresholds:v,onComplete:x,procedurePhase:k}){const L=S.useCallback(()=>{try{console.log("⏭️ handleSkipStep called - skipping to next frequency"),o("initial"),h(null),s("present"),l("Start testing at a comfortable level (30-40 dB)."),console.log("Reset phase to: initial for next frequency");const u=z.skipCurrentStep();if(console.log("Next step from TestingService:",u),u){const i=z.getCurrentSession();if(i){const a=v(i);t(a);const c=a.currentStep,f=a.testSequence[c];if(f){const g=JSON.parse(JSON.stringify(f));n(g),console.log("Moving to next frequency:",g.frequency)}else console.error("Current step data not found in updated session"),d("Error navigating to next frequency.")}else console.error("Failed to get updated session from TestingService"),d("Failed to update session data.")}else{const i=z.completeSession();if(i){p(100),console.log("Test completed, progress set to 100%");const a=v(i);x(a)}}}catch(u){console.error("Error skipping to next step:",u),d("Failed to go to next step. Please try again.")}},[v,t,n,o,s,l,h,d,p,x]),w=S.useCallback(()=>{try{if(console.log("⏮️ handlePreviousStep called - going to previous frequency"),o("initial"),h(null),s("present"),l("Returning to the previous frequency. Begin at a comfortable level."),console.log("Reset phase to: initial for previous frequency"),r){console.log("📊 Before navigating back - Current step:",r.currentStep);const u=JSON.parse(JSON.stringify(r));if(u.currentStep>0){u.currentStep-=1;const i=u.testSequence[u.currentStep];if(!i){console.error("Previous step not found in test sequence"),d("Error navigating to previous frequency.");return}console.log("📊 Going back to step:",u.currentStep,"with frequency:",i.frequency);const a=v(u);t(a);const c=a.currentStep,f=a.testSequence[c];if(f){const j=JSON.parse(JSON.stringify(f));n(j)}else{console.error("Current step data not found in preserved session"),d("Error navigating to previous frequency.");return}const g=z.getCurrentSession();g&&(g.currentStep=a.currentStep,console.log(`🔄 Explicitly updated TestingService step to ${a.currentStep} with frequency ${f.frequency}Hz`)),console.log("Moving to previous frequency:",f.frequency)}else console.log("Already at the first frequency, cannot go back further"),d("Already at the first frequency.")}else console.error("No active session found"),d("No active session. Please restart the test.")}catch(u){console.error("Error going to previous step:",u),d("Failed to go to previous step. Please try again.")}},[r,v,t,n,o,s,l,h,d]),m=S.useCallback((u,i,a,c)=>{console.log("Implementing suggested action:",u);const f=r?JSON.parse(JSON.stringify(r)):null;switch(u){case"increase":k==="initial"?(c(10),console.log("Remained in initial phase after increasing by 10dB")):(c(5),console.log("Adjusted by 5dB in ascending/threshold phase"));break;case"decrease":c(-10),console.log("Decreased by 10dB as per suggestion");break;case"store_threshold":const{isValid:g,message:j}=i();g?(a(),console.log("Stored threshold using suggested action")):(d(j),l(j+" Continue testing to establish a valid threshold."));break;case"next":if(k==="complete"&&r){const{isValid:$}=i(),C=r.currentStep;$&&C!==void 0&&!r.testSequence[C]?.completed&&(console.log("Current step has valid threshold but is not marked completed - calling handleStoreThreshold"),a())}L(),console.log("Moved to next frequency");break;case"present":if(r?.currentStep!==void 0&&r?.testSequence[r.currentStep]){const $=r.testSequence[r.currentStep].currentLevel;l(`Present the tone at ${$} dB to check for a response.`)}break;default:console.log("Unknown suggested action:",u)}if(f&&r&&JSON.stringify(f)!==JSON.stringify(r)){console.log("Session changed after action, ensuring thresholds are preserved...");const g=v(r);JSON.stringify(g)!==JSON.stringify(r)&&(console.log("Updating session with preserved thresholds"),t(g))}},[r,k,L,v,t,l,d]);return{handleSkipStep:L,handlePreviousStep:w,handleSuggestedAction:m}}const os=(r,t,n)=>{const[o,s]=S.useState(null),[l,h]=S.useState(null),[d,p]=S.useState(0),[v,x]=S.useState(!1),[k,L]=S.useState(null),[w,m]=S.useState(!1),[u,i]=S.useState(!1),[a,c]=S.useState(""),[f,g]=S.useState("initial"),[j,$]=S.useState("Start testing at a comfortable level (30-40 dB)."),[C,E]=S.useState("present"),[W,M]=S.useState(null),[V,Z]=S.useState({}),F=S.useRef(null),J=S.useRef(0),U=S.useRef(0),X=S.useRef(null),re=S.useMemo(()=>Kt(o),[o]),ee=S.useCallback(N=>Qt(N,o),[o]),T=S.useCallback(N=>{if(!l)return;const A=es(N,l,f,V,X.current,J.current,U.current);g(A.procedurePhase),E(A.suggestedAction),$(A.guidance),A.lastResponseLevel!==null&&M(A.lastResponseLevel),Z(A.responseCounts),f!=="threshold"&&A.procedurePhase==="threshold"&&(X.current=Date.now(),console.log(`⏰ Setting threshold phase start time to ${X.current}`))},[l,f,V]),{startTone:q,stopTone:I,handlePatientResponse:te}=ts({currentStep:l,toneActive:v,setToneActive:x,patientResponse:k,setPatientResponse:L,setShowResponseIndicator:m,setPatientJustResponded:i,lastPresentationTimeRef:J,lastProcessedPresentationRef:U,thresholdPhaseStartTime:X,updateTrainerState:T,patientThresholds:r.thresholds}),{handleAdjustLevel:de,handleAdjustFrequency:Ve,handleAudiogramClick:Ye}=ss({currentStep:l,session:o,setCurrentStep:h,setSession:s,procedurePhase:f,setProcedurePhase:g,setSuggestedAction:E,setCurrentGuidance:$,setLastResponseLevel:M,preserveThresholds:ee}),{validateThreshold:he,canStoreThreshold:Ue,handleStoreThreshold:ue}=ns({currentStep:l,session:o,responseCounts:V,setSession:s,setCurrentStep:h,setProcedurePhase:g,setSuggestedAction:E,setCurrentGuidance:$,setResponseCounts:Z,setErrorMessage:c}),_e=Ue(),{handleSkipStep:Je,handlePreviousStep:Xe,handleSuggestedAction:Le}=rs({session:o,setSession:s,setCurrentStep:h,setProcedurePhase:g,setSuggestedAction:E,setCurrentGuidance:$,setLastResponseLevel:M,setErrorMessage:c,setTestProgress:p,preserveThresholds:ee,onComplete:t,procedurePhase:f}),Ge=S.useCallback(()=>{Le(C,he,ue,de)},[C,he,ue,de,Le]);return S.useEffect(()=>{try{g("initial"),M(null),E("present"),$("Start testing at a comfortable level (30-40 dB)."),ne.resumeAudioContext().then(()=>{const N=z.startSession(r);s(N),h(z.getCurrentStep()),p(0),console.log("New test session started, progress initialized to 0%")})}catch(N){console.error("Error initializing test session:",N),c("Failed to initialize test session. Please try again.")}},[r]),S.useEffect(()=>{const N=()=>{v&&I()};return document.addEventListener("mouseup",N),()=>{document.removeEventListener("mouseup",N)}},[v,I]),S.useEffect(()=>()=>{F.current&&clearInterval(F.current),ne.stopTone()},[]),S.useEffect(()=>{if(o){const N=z.calculateProgress();p(N),console.log(`Test progress updated: ${N}%`),N===0&&o.testSequence.some(A=>A.completed)&&console.log("WARNING: Progress is 0% but there are completed steps:",o.testSequence.filter(A=>A.completed).map(A=>({id:A.id,freq:A.frequency,ear:A.ear,completed:A.completed,status:A.responseStatus})))}},[o,l]),{session:o,currentStep:l,testProgress:d,toneActive:v,patientResponse:k,showResponseIndicator:w,patientJustResponded:u,errorMessage:a,procedurePhase:f,currentGuidance:j,suggestedAction:C,lastResponseLevel:W,canStoreThreshold:_e,thresholds:re,startTone:q,stopTone:I,handlePatientResponse:te,handleAdjustLevel:de,handleAdjustFrequency:Ve,handleStoreThreshold:ue,handleSkipStep:Je,handlePreviousStep:Xe,handleSuggestedAction:Ge,handleAudiogramClick:Ye,validateThreshold:he}},is=({currentStep:r,testProgress:t,thresholdCount:n})=>e.jsx(H,{elevation:2,sx:{p:2,mb:2},children:e.jsxs(y,{sx:{display:"flex",flexDirection:"column"},children:[e.jsxs(y,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[e.jsx(b,{variant:"subtitle1",fontWeight:"medium",children:"Test Progress"}),e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[n!==void 0&&e.jsx(P,{label:`${n} thresholds stored`,size:"small",color:"primary",variant:"outlined"}),e.jsxs(b,{variant:"body2",color:"text.secondary",children:[t,"%"]})]})]}),e.jsx(ze,{variant:"determinate",value:t,sx:{mb:1.5,height:8,borderRadius:1}}),e.jsxs(y,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsxs(b,{variant:"body2",color:"text.secondary",children:["Frequency: ",r.frequency," Hz"]}),e.jsxs(b,{variant:"body2",color:"text.secondary",children:["Ear: ",r.ear==="left"?"Left":"Right"]}),e.jsxs(b,{variant:"body2",color:"text.secondary",children:["Current Level: ",r.currentLevel," dB HL"]})]})]})}),ls=({currentGuidance:r,suggestedAction:t,showResponseIndicator:n,patientResponse:o,canStoreThreshold:s,onStoreThreshold:l,onSuggestedAction:h,startTone:d,stopTone:p})=>{const v=x=>{x==="present"?d&&p&&(d(),setTimeout(()=>{p()},1e3)):h()};return e.jsxs(H,{elevation:2,sx:{p:2,mb:2,position:"relative",overflow:"hidden",minHeight:"6rem",display:"flex",flexDirection:"column",justifyContent:"space-between"},children:[n&&o!==null&&e.jsx(y,{sx:{position:"absolute",top:0,right:0,p:1.5,zIndex:100,display:"flex",alignItems:"center",gap:1},children:e.jsx(P,{icon:o?e.jsx(me,{}):e.jsx(nt,{}),label:o?"Heard":"Not Heard",color:o?"success":"warning",variant:"filled",size:"small"})}),e.jsx(y,{sx:{mb:2},children:e.jsx(b,{variant:"body1",sx:{mb:1,fontWeight:"500"},children:r})}),e.jsxs(y,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[s&&e.jsx(R,{variant:"outlined",color:"primary",onClick:l,size:"small",children:"Store Threshold"}),t&&e.jsx(R,{variant:"contained",color:"primary",onClick:()=>v(t),size:"small",children:as(t)})]})]})};function as(r){switch(r){case"present":return"Present Tone";case"increase":return"Increase Level";case"decrease":return"Decrease Level";case"store_threshold":return"Store Threshold";case"next":return"Next Frequency";default:return"Continue"}}const cs=({currentStep:r,toneActive:t,onAdjustLevel:n})=>{const o=t;return e.jsxs(y,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[e.jsx(b,{variant:"body2",color:"text.secondary",sx:{alignSelf:"center"},children:"Current Level"}),e.jsx(P,{label:`${r.currentLevel} dB HL`,color:"primary",variant:"outlined",size:"medium",sx:{fontWeight:"bold",fontSize:"1.1rem",width:"100px",height:"36px"}}),e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Q,{title:"Decrease Level (5dB)",children:e.jsx("span",{children:e.jsx(se,{color:"primary",disabled:o,onClick:()=>n(-5),sx:{border:"1px solid",borderColor:"divider"},size:"large",children:e.jsx(ye,{})})})}),e.jsx(Q,{title:"Increase Level (5dB)",children:e.jsx("span",{children:e.jsx(se,{color:"primary",disabled:o,onClick:()=>n(5),sx:{border:"1px solid",borderColor:"divider"},size:"large",children:e.jsx(be,{})})})})]}),e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1,mt:1},children:[e.jsx(Q,{title:"Decrease Level (10dB)",children:e.jsx("span",{children:e.jsx(se,{color:"primary",disabled:o,onClick:()=>n(-10),sx:{border:"1px solid",borderColor:"divider"},size:"small",children:e.jsx(ye,{fontSize:"small"})})})}),e.jsx(Q,{title:"Increase Level (10dB)",children:e.jsx("span",{children:e.jsx(se,{color:"primary",disabled:o,onClick:()=>n(10),sx:{border:"1px solid",borderColor:"divider"},size:"small",children:e.jsx(be,{fontSize:"small"})})})})]})]})},ds=({currentStep:r,toneActive:t,onAdjustFrequency:n})=>{const o=t;return e.jsxs(y,{sx:{display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[e.jsx(b,{variant:"body2",color:"text.secondary",sx:{alignSelf:"center"},children:"Current Frequency"}),e.jsx(P,{label:`${r.frequency} Hz`,color:"primary",variant:"outlined",size:"medium",sx:{fontWeight:"bold",fontSize:"1.1rem",width:"120px",height:"36px"}}),e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Q,{title:"Previous Frequency",children:e.jsx("span",{children:e.jsx(se,{color:"primary",disabled:o,onClick:()=>n(-1),sx:{border:"1px solid",borderColor:"divider"},size:"large",children:e.jsx(rt,{})})})}),e.jsx(Q,{title:"Next Frequency",children:e.jsx("span",{children:e.jsx(se,{color:"primary",disabled:o,onClick:()=>n(1),sx:{border:"1px solid",borderColor:"divider"},size:"large",children:e.jsx(ot,{})})})})]}),e.jsx(b,{variant:"body2",color:"text.secondary",sx:{mt:1},children:r.ear==="left"?"Left Ear":"Right Ear"})]})},hs=({currentStep:r,toneActive:t,onAdjustLevel:n,onAdjustFrequency:o,startTone:s,stopTone:l,canStoreThreshold:h,onStoreThreshold:d})=>{S.useEffect(()=>{const x=()=>{t&&l()};return document.addEventListener("mouseup",x),document.addEventListener("touchend",x),()=>{document.removeEventListener("mouseup",x),document.removeEventListener("touchend",x),t&&l()}},[t,l]);const p=x=>{x.preventDefault(),s()},v=x=>{x.preventDefault(),s()};return e.jsx(y,{sx:{width:"100%"},children:e.jsxs(D,{container:!0,spacing:2,children:[e.jsx(D,{item:!0,xs:12,children:e.jsx(H,{elevation:2,sx:{p:2,mb:2},children:e.jsxs(y,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},justifyContent:"space-between",alignItems:"center",gap:2},children:[e.jsx(y,{sx:{display:"flex",justifyContent:"center",flex:1},children:e.jsx(Q,{title:t?"Release to stop tone":"Press and hold to present tone",children:e.jsx(R,{variant:t?"outlined":"contained",color:"primary",startIcon:t?e.jsx(it,{}):e.jsx(je,{}),onMouseDown:p,onTouchStart:v,size:"large",sx:{px:3,py:1.5,width:"100%",maxWidth:"200px",borderRadius:"28px"},children:t?"Stop Tone":"Present Tone"})})}),e.jsx(y,{sx:{display:"flex",justifyContent:"center",flex:1},children:e.jsx(Q,{title:h?"Store the current level as the threshold for this frequency":"More responses needed to determine threshold",children:e.jsxs("span",{children:[" ",e.jsx(R,{variant:"contained",color:"success",startIcon:e.jsx(De,{}),onClick:d,disabled:!h||t,sx:{py:1.5,width:"100%",maxWidth:"200px",fontWeight:"medium"},children:"Store Threshold"})]})})})]})})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(H,{elevation:2,sx:{p:2,height:"100%"},children:[e.jsx(b,{variant:"subtitle1",gutterBottom:!0,fontWeight:"medium",children:"Level Control"}),e.jsx(cs,{currentStep:r,toneActive:t,onAdjustLevel:n})]})}),e.jsx(D,{item:!0,xs:12,sm:6,children:e.jsxs(H,{elevation:2,sx:{p:2,height:"100%"},children:[e.jsx(b,{variant:"subtitle1",gutterBottom:!0,fontWeight:"medium",children:"Frequency Control"}),e.jsx(ds,{currentStep:r,toneActive:t,onAdjustFrequency:o})]})})]})})},us=({thresholds:r,currentStep:t,toneActive:n,onAudiogramClick:o})=>{console.log("AudiogramContainer received thresholds:",r);const s=[125,250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3],l=[-10,-5,0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110],h=[-10,0,10,20,30,40,50,60,70,80,90,100,110],d=[-10,0,10,20,30,40,50,60,70,80,90,100,110],p=i=>d.includes(i),v=[125,250,500,1e3,2e3,4e3,8e3],x=i=>v.includes(i),k=(i,a)=>{const c=s.indexOf(i),f=l.indexOf(a);if(c===-1||f===-1)return null;const g=c/(s.length-1)*100,j=f/(l.length-1)*100;return{x:g,y:j}},L=r.filter(i=>i.ear==="left"),w=r.filter(i=>i.ear==="right");console.log("Left ear thresholds to display:",L),console.log("Right ear thresholds to display:",w);const m=i=>{if(!o)return;const a=i.currentTarget.getBoundingClientRect(),c=i.clientX-a.left,f=i.clientY-a.top,g=Math.round(c/a.width*(s.length-1)),j=Math.round(f/a.height*(l.length-1)),$=s[Math.max(0,Math.min(g,s.length-1))],C=l[Math.max(0,Math.min(j,l.length-1))];o($,t.ear,C)},u=i=>i>=1e3?`${i/1e3}k`:i.toString();return e.jsxs(H,{elevation:3,sx:{p:2,mb:3,position:"relative",overflow:"hidden",maxWidth:"85%",margin:"0 auto",paddingLeft:"60px"},children:[e.jsxs(b,{variant:"h6",sx:{mb:2,display:"flex",justifyContent:"space-between"},children:[e.jsx("span",{children:"Audiogram"}),e.jsxs(b,{variant:"body2",color:"text.secondary",children:["Testing: ",t.frequency," Hz, ",t.ear==="left"?"Left":"Right"," ear",t.testType==="air"?" (Air Conduction)":" (Bone Conduction)"]})]}),e.jsxs(y,{sx:{position:"relative",height:"260px",border:"1px solid",borderColor:"divider",cursor:o?"pointer":"default",backgroundColor:"rgba(250, 250, 250, 0.5)"},onClick:m,children:[s.map((i,a)=>{const c=a/(s.length-1)*100;return e.jsx(y,{sx:{position:"absolute",left:`${c}%`,top:0,height:"100%",width:"1px",...x(i)?{borderLeft:"1px solid rgba(0, 0, 0, 0.3)",backgroundColor:"rgba(0, 0, 0, 0.08)"}:{borderLeft:"1px dashed rgba(0, 0, 0, 0.2)",backgroundColor:"transparent"},...t.frequency===i?{backgroundColor:"rgba(25, 118, 210, 0.1)",borderLeft:"1px solid rgba(25, 118, 210, 0.5)"}:{},zIndex:1}},`line-${i}`)}),h.map((i,a)=>{const c=l.indexOf(i)/(l.length-1)*100;return e.jsx(y,{sx:{position:"absolute",left:0,top:`${c}%`,width:"100%",height:"1px",backgroundColor:"rgba(0, 0, 0, 0.05)",borderTop:i%20===0?"1px solid rgba(0, 0, 0, 0.2)":"1px solid rgba(0, 0, 0, 0.1)",...t.currentLevel===i?{backgroundColor:"rgba(25, 118, 210, 0.1)",borderTop:"1px solid rgba(25, 118, 210, 0.5)"}:{},zIndex:1}},`hline-${i}`)}),e.jsxs(y,{sx:{position:"absolute",bottom:"-30px",left:0,right:0,display:"flex",flexDirection:"column"},children:[e.jsx(y,{sx:{display:"flex",justifyContent:"space-between",px:"5px",pt:"5px"},children:s.map(i=>e.jsx(b,{variant:"caption",sx:{transform:"translateX(-50%)",fontWeight:t.frequency===i?"bold":"normal",color:t.frequency===i?"primary.main":"text.secondary",fontSize:"0.7rem"},children:u(i)},i))}),e.jsx(b,{variant:"caption",sx:{textAlign:"center",mt:1,fontWeight:"medium",fontSize:"0.75rem"},children:"Frequency (Hz)"})]}),e.jsxs(y,{sx:{position:"absolute",top:0,left:"-50px",bottom:0,height:"100%",width:"50px",display:"flex",flexDirection:"column",justifyContent:"space-between",py:"5px"},children:[e.jsx(b,{variant:"caption",sx:{position:"absolute",left:"-30px",top:"50%",transform:"rotate(-90deg) translateX(50%)",transformOrigin:"left center",fontWeight:"bold",whiteSpace:"nowrap"},children:"Hearing Level (dB HL)"}),l.map(i=>{const a=l.indexOf(i)/(l.length-1)*100;return p(i)?e.jsx(b,{variant:"caption",sx:{position:"absolute",left:0,top:`${a}%`,transform:"translateY(-50%)",fontWeight:t.currentLevel===i?"bold":"normal",color:t.currentLevel===i?"primary.main":"text.secondary",width:"45px",textAlign:"right",fontSize:"0.75rem",paddingRight:"5px"},children:i},i):null})]}),(()=>{const i=k(t.frequency,t.currentLevel);return i?e.jsx(y,{sx:{position:"absolute",left:`${i.x}%`,top:`${i.y}%`,width:"12px",height:"12px",borderRadius:"50%",backgroundColor:n?"primary.main":"rgba(25, 118, 210, 0.5)",transform:"translate(-50%, -50%)",boxShadow:"0 0 0 2px white",transition:"background-color 0.3s",animation:n?"pulse 1.5s infinite":"none","@keyframes pulse":{"0%":{boxShadow:"0 0 0 0 rgba(25, 118, 210, 0.7)"},"70%":{boxShadow:"0 0 0 10px rgba(25, 118, 210, 0)"},"100%":{boxShadow:"0 0 0 0 rgba(25, 118, 210, 0)"}}}}):null})(),L.map(i=>{const a=k(i.frequency,i.level);if(!a)return null;const c=w.some(j=>j.frequency===i.frequency&&j.level===i.level),f=c?-1.5:0,g=c?-1.5:0;return i.testType==="air"?e.jsx(y,{sx:{position:"absolute",left:`calc(${a.x}% + ${f}px)`,top:`calc(${a.y}% + ${g}px)`,width:"16px",height:"16px",transform:"translate(-50%, -50%)",zIndex:4,"&:before":{content:'""',position:"absolute",width:"10px",height:"10px",backgroundColor:"rgba(255, 255, 255, 0.75)",borderRadius:"2px",left:"3px",top:"3px",zIndex:-1},"&:after":{content:'""',position:"absolute",backgroundColor:"#2196f3",display:"block",width:"16px",height:"3px",top:"6.5px",left:"0px",borderRadius:"1px",transform:"rotate(45deg)",boxShadow:"0 0 1px rgba(0,0,0,0.5)"}},children:e.jsx(y,{sx:{position:"absolute",backgroundColor:"#2196f3",width:"16px",height:"3px",top:"6.5px",left:"0px",borderRadius:"1px",transform:"rotate(-45deg)",boxShadow:"0 0 1px rgba(0,0,0,0.5)"}})},`left-air-${i.frequency}`):e.jsx(y,{sx:{position:"absolute",left:`calc(${a.x}% + ${f}px)`,top:`calc(${a.y}% + ${g}px)`,width:"14px",height:"14px",transform:"translate(-50%, -50%)",zIndex:4,"&:before":{content:'">"',position:"absolute",color:"#2196f3",fontSize:"16px",fontWeight:"bold",lineHeight:"14px",top:"0px",left:"0px",textShadow:"0 0 3px rgba(255,255,255,0.9)"}}},`left-bone-${i.frequency}`)}),w.map(i=>{const a=k(i.frequency,i.level);if(!a)return null;const c=L.some(j=>j.frequency===i.frequency&&j.level===i.level),f=c?1.5:0,g=c?1.5:0;return i.testType==="air"?e.jsx(y,{sx:{position:"absolute",left:`calc(${a.x}% + ${f}px)`,top:`calc(${a.y}% + ${g}px)`,width:"14px",height:"14px",borderRadius:"50%",border:"3px solid #f44336",backgroundColor:"rgba(255, 255, 255, 0.85)",transform:"translate(-50%, -50%)",zIndex:3,boxShadow:"0 0 2px rgba(0,0,0,0.3)"}},`right-air-${i.frequency}`):e.jsx(y,{sx:{position:"absolute",left:`calc(${a.x}% + ${f}px)`,top:`calc(${a.y}% + ${g}px)`,width:"14px",height:"14px",transform:"translate(-50%, -50%)",zIndex:3,"&:before":{content:'"<"',position:"absolute",color:"#f44336",fontSize:"16px",fontWeight:"bold",lineHeight:"14px",top:"0px",left:"0px",textShadow:"0 0 3px rgba(255,255,255,0.9)"}}},`right-bone-${i.frequency}`)})]}),e.jsxs(y,{sx:{display:"flex",flexWrap:"wrap",justifyContent:"center",gap:3,mt:3},children:[e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(y,{sx:{width:"10px",height:"10px",position:"relative","&:before, &:after":{content:'""',position:"absolute",backgroundColor:"#2196f3",width:"10px",height:"2px"},"&:before":{transform:"rotate(45deg)"},"&:after":{transform:"rotate(-45deg)"}}}),e.jsx(b,{variant:"caption",children:"Left Ear (Air)"})]}),e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(y,{sx:{width:"10px",height:"10px",borderRadius:"50%",border:"2px solid #f44336",backgroundColor:"white"}}),e.jsx(b,{variant:"caption",children:"Right Ear (Air)"})]}),e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(b,{variant:"h6",sx:{color:"#2196f3",fontWeight:"bold",lineHeight:1,fontSize:"18px"},children:">"}),e.jsx(b,{variant:"caption",children:"Left Ear (Bone)"})]}),e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(b,{variant:"h6",sx:{color:"#f44336",fontWeight:"bold",lineHeight:1,fontSize:"18px"},children:"<"}),e.jsx(b,{variant:"caption",children:"Right Ear (Bone)"})]}),e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(y,{sx:{width:"14px",height:"2px",backgroundColor:"rgba(0, 0, 0, 0.3)"}}),e.jsx(b,{variant:"caption",children:"Octave"})]}),e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(y,{sx:{width:"14px",height:"0px",borderTop:"2px dashed rgba(0, 0, 0, 0.2)"}}),e.jsx(b,{variant:"caption",children:"Inter-octave"})]})]})]})},ps=Ae`
  0% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.8; transform: scale(1.05); }
  100% { opacity: 1; transform: scale(1); }
`,gs=Ae`
  0% { box-shadow: 0 0 0 0 rgba(25, 118, 210, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(25, 118, 210, 0); }
  100% { box-shadow: 0 0 0 0 rgba(25, 118, 210, 0); }
`;ie(P)(({theme:r})=>({margin:r.spacing(1),fontWeight:"bold",padding:r.spacing(2,1),height:"auto","& .MuiChip-label":{padding:r.spacing(.5,1)},"& .MuiChip-icon":{fontSize:"1.2rem"}}));ie(y)(({theme:r})=>({padding:r.spacing(1),borderRadius:r.shape.borderRadius,backgroundColor:r.palette.grey[100],display:"flex",alignItems:"center"}));const fs=ie(K)(({theme:r})=>({marginBottom:r.spacing(2),fontWeight:"bold",animation:`${ps} 1.5s infinite ease-in-out`,boxShadow:"0 4px 10px rgba(76, 175, 80, 0.3)",border:"1px solid #4caf50"})),xs=ie(P)(({theme:r})=>({fontWeight:"bold",fontSize:"0.85rem",padding:r.spacing(.5,1),marginBottom:r.spacing(1)})),ms=ie(R)(({theme:r})=>({marginTop:r.spacing(1),textTransform:"none",fontWeight:"500"})),ys=({guidance:r,action:t,phase:n,onStoreThreshold:o,canStoreThreshold:s,patientResponded:l=!1,onImplementSuggestion:h,showResponseAlert:d=!1})=>{const[p,v]=S.useState(!1),[x,k]=S.useState(!1),L=oe();S.useEffect(()=>{if(console.log("GuidancePanel received patientResponded:",l),l){console.log("Setting responseDetected to true"),v(!0);const g=setTimeout(()=>{v(!1)},8e3);return()=>{console.log("Cleaning up timer"),clearTimeout(g)}}},[l]);const m={increase:{label:"Increase Level (+5 dB)",icon:e.jsx(be,{}),color:"primary",description:"Increase the hearing level by 5 dB. This smaller step size is used during the ascending phase and after no-response during bracketing to precisely identify the threshold."},decrease:{label:"Decrease Level (-10 dB)",icon:e.jsx(ye,{}),color:"secondary",description:"Decrease the hearing level by 10 dB. After ANY positive response, the Hughson-Westlake protocol requires an immediate 10 dB decrease to prevent adaptation and maintain stimulus uncertainty."},present:{label:"Present Tone",icon:e.jsx(je,{}),color:"info",description:"Present a 1-2 second tone burst to check if the patient can hear it at the current level. Short tone bursts enhance detectability compared to continuous tones."},store_threshold:{label:"Store Threshold",icon:e.jsx(me,{}),color:"success",description:"The threshold has been determined (≥2 responses out of 3 presentations at the same level). This is the lowest intensity that achieves a 50% or greater response rate during ascending trials."},next:{label:"Next Frequency",icon:e.jsx(ft,{}),color:"warning",description:"Move to the next test frequency. The standard sequence (1→2→4→8 kHz then 0.25→0.5 kHz) minimizes cross-frequency masking effects."}}[t]||{label:"Continue Testing",icon:e.jsx(gt,{}),description:"Continue with the testing procedure following the Hughson-Westlake protocol."},u={initial:{name:"Initial Presentation",description:"Start with a comfortable level that the patient is likely to hear (30-40 dB HL).",tips:["Begin at a level 30-40 dB above estimated threshold (typically 1 kHz initially)","Present a clearly audible tone for 1-2 seconds to establish baseline","Short tone bursts are more detectable than continuous tones","If no response, increase in 10-15 dB steps until response is obtained"]},descending:{name:"Initial Descent",description:"Decrease intensity in 10 dB steps until the patient no longer responds.",tips:["After each response, immediately decrease by 10 dB steps","Continue the descent until the patient fails to respond","The descending phase identifies the sub-threshold boundary","This large step size (10 dB) efficiently approaches the threshold region","Responses during this phase do not count towards threshold determination"]},ascending:{name:"Initial Ascent",description:"From the last non-responsive level, increase intensity in 5 dB steps until the patient responds again.",tips:["After no response, increase by 5 dB steps","Smaller step size (5 dB) provides more precise threshold determination","Continue until the patient responds again","This first ascending response only identifies the threshold region and does not count towards threshold determination"]},threshold:{name:"Bracketing Phase",description:"Use the 10 dB down / 5 dB up bracketing technique to determine threshold.",tips:["After each response: immediately reduce level by 10 dB","After no response: increase by 5 dB steps","Threshold is defined as the lowest level with ≥50% response rate","Required: 2/3 responses at the same level for automated testing","Must not stagnate at a single level; each response triggers a mandatory 10 dB descent","Continue the oscillatory pattern until meeting threshold criteria"]},complete:{name:"Threshold Complete",description:"The threshold has been established. Record this value and proceed to the next frequency.",tips:["Store the current level as the threshold for this frequency","The threshold is defined as the lowest level at which at least 2 out of 3 responses are obtained","Verify the threshold with a non-response at 5 dB below the threshold level","Move to the next test frequency and repeat the procedure","Standard sequence is 1→2→4→8 kHz then 0.25→0.5 kHz to minimize cross-frequency masking"]}},i=u[n]||u.initial,a=d||l,c=a||p,f=()=>{h&&h()};return e.jsxs(H,{elevation:3,sx:{p:3,mb:2,backgroundColor:c?L.palette.mode==="dark"?G(L.palette.success.dark,.1):"#f5fff5":L.palette.mode==="dark"?L.palette.background.paper:"#f8f9fa",borderLeft:c?"4px solid #4caf50":"4px solid #3f51b5",position:"relative",transition:"all 0.3s ease"},children:[a&&e.jsx(fs,{icon:e.jsx(lt,{sx:{fontSize:24}}),severity:"success",children:"Patient has responded to the tone! Follow the suggested action below."}),e.jsxs(y,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(at,{color:"primary",sx:{mr:2,fontSize:28}}),e.jsx(b,{variant:"h6",fontWeight:"bold",children:"Hughson-Westlake Training Guide"})]}),e.jsxs(y,{sx:{mb:3},children:[e.jsx(xs,{label:i.name,size:"medium",color:n==="complete"?"success":"primary",sx:{fontWeight:"bold",px:1}}),e.jsx(b,{variant:"body1",sx:{fontWeight:500,mb:1},children:i.description}),e.jsx(ms,{startIcon:x?e.jsx(Ee,{}):e.jsx(He,{}),onClick:()=>k(!x),color:"primary",variant:"text",size:"small",children:x?"Hide Details":"Show Procedure Details"}),e.jsx(We,{in:x,children:e.jsxs(y,{sx:{mt:1,p:2,backgroundColor:L.palette.mode==="dark"?G(L.palette.background.paper,.6):"#f5f5f5",borderRadius:1,border:`1px solid ${L.palette.divider}`},children:[e.jsxs(b,{variant:"subtitle2",fontWeight:"bold",gutterBottom:!0,children:[i.name," - Procedure Tips:"]}),e.jsx(ct,{dense:!0,children:i.tips.map((g,j)=>e.jsxs(dt,{sx:{py:.5},children:[e.jsx(ht,{sx:{minWidth:28},children:e.jsx(ut,{color:"primary",fontSize:"small"})}),e.jsx(pt,{primary:g})]},j))})]})})]}),e.jsx(le,{sx:{my:2}}),e.jsxs(y,{sx:{mb:3},children:[e.jsx(b,{variant:"subtitle1",fontWeight:"bold",gutterBottom:!0,children:"Current Guidance:"}),e.jsx(b,{variant:"body1",sx:{p:2,backgroundColor:c?L.palette.mode==="dark"?G(L.palette.success.dark,.2):"#e8f5e9":L.palette.mode==="dark"?G(L.palette.primary.dark,.1):"#e3f2fd",borderRadius:2,fontWeight:500,border:c?`1px solid ${L.palette.success.main}`:`1px solid ${L.palette.mode==="dark"?L.palette.primary.dark:"#bbdefb"}`,transition:"all 0.3s ease",boxShadow:"0 1px 3px rgba(0,0,0,0.12)"},children:r})]}),e.jsxs(y,{sx:{mt:3},children:[e.jsx(b,{variant:"subtitle1",fontWeight:"bold",gutterBottom:!0,children:"Suggested Action:"}),e.jsxs(y,{sx:{display:"flex",flexDirection:"column",alignItems:"flex-start",mt:1,p:2,borderRadius:2,backgroundColor:L.palette.mode==="dark"?G(L.palette.background.paper,.6):"#f8f9fa",border:`1px solid ${L.palette.divider}`,boxShadow:"0 1px 3px rgba(0,0,0,0.08)",animation:t==="store_threshold"||t==="present"?`${gs} 2s infinite`:"none"},children:[e.jsxs(y,{sx:{display:"flex",flexDirection:"column",width:"100%",mb:2},children:[e.jsx(b,{variant:"body1",fontWeight:"medium",gutterBottom:!0,children:m.label}),e.jsx(b,{variant:"body2",color:"text.secondary",children:m.description})]}),t!=="present"&&h&&e.jsx(R,{variant:"contained",color:"primary",onClick:f,startIcon:m.icon,sx:{mt:1,alignSelf:"flex-end"},children:"Implement This Suggestion"})]}),t==="store_threshold"&&s&&o&&e.jsx(R,{variant:"contained",color:"success",startIcon:e.jsx(me,{}),onClick:o,sx:{mt:2,px:3,py:1.5,boxShadow:"0 4px 10px rgba(76, 175, 80, 0.3)",fontWeight:"bold"},fullWidth:!0,children:"Store This Threshold & Continue"})]})]})},bs=({patient:r,onComplete:t,onCancel:n})=>{const{session:o,currentStep:s,testProgress:l,toneActive:h,patientResponse:d,showResponseIndicator:p,patientJustResponded:v,errorMessage:x,procedurePhase:k,currentGuidance:L,suggestedAction:w,canStoreThreshold:m,thresholds:u,startTone:i,stopTone:a,handleAdjustLevel:c,handleAdjustFrequency:f,handleStoreThreshold:g,handleSuggestedAction:j,handleAudiogramClick:$}=os(r,t),[C,E]=S.useState(!1),[W,M]=S.useState(!1),[V,Z]=S.useState(null),F=oe(),J=(T,q,I)=>{$(T,I)},U=()=>{E(!C)};console.log("Original thresholds from useAudioTest:",u);const X=u.map(T=>(console.log("Converting threshold point:",T),{frequency:T.frequency,ear:T.ear,level:T.hearingLevel,testType:T.testType}));console.log("Converted thresholds for AudiogramContainer:",X);const re=()=>{if(o){l<100&&m&&g();const T=z.completeSession();if(T&&(console.log("Session completed manually with results:",T.results),T.results)){const q={...o,completed:!0,results:T.results};Object.assign(o,q)}M(!0)}else Z("Cannot complete the test: No active session found.")};if(!o||!s)return e.jsxs(y,{sx:{p:3,textAlign:"center"},children:[e.jsx(b,{variant:"h6",children:"Initializing test session..."}),e.jsx(ze,{sx:{mt:2}}),x&&e.jsx(K,{severity:"error",sx:{mt:2},children:x})]});const ee=l===100;return e.jsxs(y,{sx:{padding:{xs:.5,sm:1,md:2},maxWidth:"100%",overflowX:"hidden"},children:[e.jsxs(D,{container:!0,spacing:{xs:1,sm:1.5,md:2},children:[e.jsx(D,{item:!0,xs:12,children:e.jsx(is,{currentStep:s,testProgress:l,thresholdCount:u.length})}),e.jsx(D,{item:!0,xs:12,children:e.jsx(y,{sx:{height:"calc(100% + 4%)",width:"100%"},children:e.jsx(us,{thresholds:X,currentStep:s,toneActive:h,onAudiogramClick:J})})}),!ee&&e.jsx(D,{item:!0,xs:12,children:e.jsxs(H,{elevation:3,sx:{p:{xs:1,sm:2},mb:1.5},children:[e.jsxs(y,{sx:{mb:1.5},children:[e.jsxs(y,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:.5},children:[e.jsxs(b,{variant:"h6",component:"div",sx:{display:"flex",alignItems:"center",fontSize:{xs:"1rem",sm:"1.25rem"}},children:[e.jsx(xt,{sx:{mr:1,fontSize:{xs:"1.1rem",sm:"1.3rem"}}})," Current Guidance"]}),e.jsx(R,{size:"small",endIcon:C?e.jsx(Ee,{}):e.jsx(He,{}),onClick:U,children:C?"Hide Details":"Show Details"})]}),e.jsx(ls,{currentGuidance:L,suggestedAction:w,showResponseIndicator:p,patientResponse:d,canStoreThreshold:m,onStoreThreshold:g,onSuggestedAction:j,startTone:i,stopTone:a}),e.jsx(We,{in:C,children:e.jsx(y,{sx:{mt:1.5,p:1.5,bgcolor:G(F.palette.primary.light,.1),borderRadius:1},children:e.jsx(ys,{guidance:L,action:w,phase:k,onStoreThreshold:g,canStoreThreshold:m,patientResponded:v,onImplementSuggestion:j,showResponseAlert:p&&!!d})})})]}),e.jsxs(y,{sx:{p:{xs:.5,sm:1}},children:[e.jsxs(b,{variant:"subtitle1",sx:{mb:1,display:"flex",alignItems:"center",fontSize:{xs:"0.9rem",sm:"1rem"}},children:[e.jsx(je,{sx:{mr:1,fontSize:"1.2rem"}})," Test Controls"]}),e.jsx(hs,{currentStep:s,toneActive:h,onAdjustLevel:c,onAdjustFrequency:f,startTone:i,stopTone:a,canStoreThreshold:m,onStoreThreshold:g})]})]})}),ee&&e.jsx(D,{item:!0,xs:12,children:e.jsxs(H,{elevation:3,sx:{p:{xs:2,sm:3},mb:2,display:"flex",flexDirection:"column",alignItems:"center",backgroundColor:F.palette.success.light,color:F.palette.success.contrastText},children:[e.jsx(b,{variant:"h5",gutterBottom:!0,children:"Audiogram Test Complete!"}),e.jsx(b,{variant:"body1",sx:{mb:3,textAlign:"center"},children:"You have successfully completed the hearing test. Review the audiogram to see the patient's thresholds."}),e.jsx(R,{variant:"contained",color:"primary",startIcon:e.jsx(mt,{}),onClick:()=>{if(o&&!o.completed){const T=z.completeSession();T&&T.results&&Object.assign(o,{completed:!0,results:T.results})}M(!0)},sx:{mb:1},children:"View Detailed Results"}),e.jsx(R,{variant:"outlined",onClick:()=>t(o),children:"Return to Dashboard"})]})}),e.jsx(D,{item:!0,xs:12,sx:{display:"flex",justifyContent:"center",mt:{xs:1.5,sm:2},mb:{xs:1,sm:1.5}},children:e.jsx(R,{variant:"contained",color:"primary",size:"large",startIcon:e.jsx(yt,{}),onClick:re,sx:{mx:"auto",minWidth:{xs:"180px",sm:"200px"},backgroundColor:F.palette.success.main,"&:hover":{backgroundColor:F.palette.success.dark}},children:"Complete Audiogram Test"})}),e.jsx(D,{item:!0,xs:12,sx:{display:"flex",justifyContent:"center",mt:.5},children:e.jsx(Q,{title:"Go back",children:e.jsx(se,{onClick:n,color:"primary",sx:{backgroundColor:F.palette.mode==="dark"?G(F.palette.action.active,.1):"rgba(0, 0, 0, 0.05)","&:hover":{backgroundColor:F.palette.mode==="dark"?G(F.palette.action.active,.2):"rgba(0, 0, 0, 0.1)"}},children:e.jsx(bt,{sx:{transform:"rotate(180deg)"}})})})})]}),e.jsxs(Me,{open:W,onClose:()=>M(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Fe,{children:"Patient Audiogram Results"}),e.jsx(Ne,{children:e.jsxs(y,{sx:{p:2},children:[e.jsx(b,{variant:"h6",gutterBottom:!0,children:"Patient Information"}),e.jsxs(D,{container:!0,spacing:2,sx:{mb:3},children:[e.jsxs(D,{item:!0,xs:12,sm:6,children:[e.jsxs(b,{variant:"body2",children:[e.jsx("strong",{children:"Patient ID:"})," ",r.id]}),e.jsxs(b,{variant:"body2",children:[e.jsx("strong",{children:"Name:"})," ",r.name]})]}),e.jsxs(D,{item:!0,xs:12,sm:6,children:[e.jsxs(b,{variant:"body2",children:[e.jsx("strong",{children:"Hearing Loss Type:"})," ",r.hearingLossType.replace("_"," ")]}),e.jsxs(b,{variant:"body2",children:[e.jsx("strong",{children:"Test Date:"})," ",new Date().toLocaleDateString()]})]})]}),e.jsx(b,{variant:"h6",gutterBottom:!0,children:"Your Test Results vs. Actual Thresholds"}),e.jsxs(H,{elevation:1,sx:{p:2,mb:3,bgcolor:"background.paper"},children:[e.jsx(b,{variant:"body2",paragraph:!0,children:"Below is a comparison between the thresholds you measured and the patient's actual thresholds. This feedback helps you improve your audiometric testing skills."}),o?.completed&&o?.results&&e.jsxs(K,{severity:o.results.falsePositives>5?"warning":"info",sx:{mb:2},children:[e.jsxs(b,{variant:"subtitle2",children:["False Positives: ",o.results.falsePositives||0]}),e.jsxs(b,{variant:"body2",children:["False positives occur when a patient indicates hearing a tone when none was presented. A high number of false positives (",">","5) may indicate an unreliable test subject or a need for clearer instructions."]})]}),e.jsxs(D,{container:!0,spacing:2,children:[e.jsxs(D,{item:!0,xs:12,md:6,children:[e.jsxs(b,{variant:"subtitle2",gutterBottom:!0,children:["Left Ear Thresholds ",r.thresholds.some(T=>T.ear==="left"&&T.testType==="bone")?"(>)":"(O)"]}),e.jsxs(ae,{size:"small",children:[e.jsx(ve,{children:e.jsxs(Y,{children:[e.jsx(B,{children:"Frequency (Hz)"}),e.jsx(B,{children:"Your Result (dB)"}),e.jsx(B,{children:"Actual (dB)"}),e.jsx(B,{children:"Difference"})]})}),e.jsx(ce,{children:u.filter(T=>T.ear==="left").map(T=>{const q=r.thresholds.find(te=>te.ear==="left"&&te.frequency===T.frequency),I=q?T.hearingLevel-q.hearingLevel:0;return e.jsxs(Y,{children:[e.jsx(B,{children:T.frequency}),e.jsx(B,{children:T.hearingLevel}),e.jsx(B,{children:q?q.hearingLevel:"N/A"}),e.jsx(B,{sx:{color:Math.abs(I)<=5?"success.main":Math.abs(I)<=10?"warning.main":"error.main"},children:I>0?`+${I}`:I})]},`left-${T.frequency}`)})})]})]}),e.jsxs(D,{item:!0,xs:12,md:6,children:[e.jsxs(b,{variant:"subtitle2",gutterBottom:!0,children:["Right Ear Thresholds ",r.thresholds.some(T=>T.ear==="right"&&T.testType==="bone")?"(<)":"(X)"]}),e.jsxs(ae,{size:"small",children:[e.jsx(ve,{children:e.jsxs(Y,{children:[e.jsx(B,{children:"Frequency (Hz)"}),e.jsx(B,{children:"Your Result (dB)"}),e.jsx(B,{children:"Actual (dB)"}),e.jsx(B,{children:"Difference"})]})}),e.jsx(ce,{children:u.filter(T=>T.ear==="right").map(T=>{const q=r.thresholds.find(te=>te.ear==="right"&&te.frequency===T.frequency),I=q?T.hearingLevel-q.hearingLevel:0;return e.jsxs(Y,{children:[e.jsx(B,{children:T.frequency}),e.jsx(B,{children:T.hearingLevel}),e.jsx(B,{children:q?q.hearingLevel:"N/A"}),e.jsx(B,{sx:{color:Math.abs(I)<=5?"success.main":Math.abs(I)<=10?"warning.main":"error.main"},children:I>0?`+${I}`:I})]},`right-${T.frequency}`)})})]})]})]})]})]})}),e.jsxs(Oe,{children:[e.jsx(R,{onClick:()=>M(!1),children:"Close"}),e.jsx(R,{variant:"contained",color:"primary",onClick:()=>{if(M(!1),o&&!o.completed){const T=z.completeSession();T?(console.log("Session completed with results:",T.results),t(T)):(console.warn("Failed to complete session, using current session instead"),t(o))}else t(o)},children:"Finish"})]})]}),x&&e.jsx(we,{open:!!x,autoHideDuration:6e3,onClose:()=>{},children:e.jsx(K,{severity:"error",children:x})}),V&&e.jsx(we,{open:!!V,autoHideDuration:6e3,onClose:()=>{},children:e.jsx(K,{severity:"error",children:V})})]})};Ht.register(Wt,At,Mt,Ft,Nt,Ot,Pt,Vt);const Ie=[125,250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3],vs=[250,500,1e3,2e3,4e3,8e3],js=({thresholds:r,width:t=600,height:n=400,showLegend:o=!0,title:s="Audiogram",compareThresholds:l,currentFrequency:h,currentLevel:d,toneActive:p=!1,onPositionClick:v,interactive:x=!1})=>{const k=S.useRef(null),[L,w]=S.useState(!1);S.useEffect(()=>()=>{k.current&&k.current.destroy()},[]),S.useEffect(()=>{let a=null;return p&&h&&d!==void 0?a=setInterval(()=>{w(c=>!c)},200):w(!1),()=>{a&&clearInterval(a)}},[p,h,d]);const m=()=>{const a=[];return a.push({label:"Right Ear (Air)",data:r.filter(c=>c.ear==="right"&&c.testType==="air").map(c=>({x:c.frequency,y:c.hearingLevel,responseStatus:c.responseStatus})),pointStyle:"circle",borderColor:"red",backgroundColor:"red",borderWidth:2,pointRadius:6,showLine:!0,tension:.1}),a.push({label:"Left Ear (Air)",data:r.filter(c=>c.ear==="left"&&c.testType==="air").map(c=>({x:c.frequency,y:c.hearingLevel,responseStatus:c.responseStatus})),pointStyle:"crossRot",borderColor:"blue",backgroundColor:"blue",borderWidth:2,pointRadius:6,showLine:!0,tension:.1}),a.push({label:"Right Ear (Bone)",data:r.filter(c=>c.ear==="right"&&c.testType==="bone").map(c=>({x:c.frequency,y:c.hearingLevel,responseStatus:c.responseStatus})),pointStyle:"triangle",borderColor:"red",backgroundColor:"rgba(255, 0, 0, 0.2)",borderWidth:2,pointRadius:6,showLine:!0,tension:.1}),a.push({label:"Left Ear (Bone)",data:r.filter(c=>c.ear==="left"&&c.testType==="bone").map(c=>({x:c.frequency,y:c.hearingLevel,responseStatus:c.responseStatus})),pointStyle:"triangle",borderColor:"blue",backgroundColor:"rgba(0, 0, 255, 0.2)",borderWidth:2,pointRadius:6,showLine:!0,tension:.1,rotation:180}),l&&(a.push({label:"Right Ear Air (Expected)",data:l.filter(c=>c.ear==="right"&&c.testType==="air").map(c=>({x:c.frequency,y:c.hearingLevel,responseStatus:c.responseStatus})),pointStyle:"circle",borderColor:"rgba(255, 0, 0, 0.5)",backgroundColor:"rgba(255, 0, 0, 0.5)",borderWidth:1,pointRadius:4,showLine:!0,tension:.1,borderDash:[5,5]}),a.push({label:"Left Ear Air (Expected)",data:l.filter(c=>c.ear==="left"&&c.testType==="air").map(c=>({x:c.frequency,y:c.hearingLevel,responseStatus:c.responseStatus})),pointStyle:"crossRot",borderColor:"rgba(0, 0, 255, 0.5)",backgroundColor:"rgba(0, 0, 255, 0.5)",borderWidth:1,pointRadius:4,showLine:!0,tension:.1,borderDash:[5,5]}),a.push({label:"Right Ear Bone (Expected)",data:l.filter(c=>c.ear==="right"&&c.testType==="bone").map(c=>({x:c.frequency,y:c.hearingLevel,responseStatus:c.responseStatus})),pointStyle:"triangle",borderColor:"rgba(255, 0, 0, 0.5)",backgroundColor:"rgba(255, 0, 0, 0.2)",borderWidth:1,pointRadius:4,showLine:!0,tension:.1,borderDash:[5,5]}),a.push({label:"Left Ear Bone (Expected)",data:l.filter(c=>c.ear==="left"&&c.testType==="bone").map(c=>({x:c.frequency,y:c.hearingLevel,responseStatus:c.responseStatus})),pointStyle:"triangle",borderColor:"rgba(0, 0, 255, 0.5)",backgroundColor:"rgba(0, 0, 255, 0.2)",borderWidth:1,pointRadius:4,showLine:!0,tension:.1,borderDash:[5,5],rotation:180})),h!==void 0&&d!==void 0&&(a.push({label:"Current Frequency",data:[{x:h,y:-10},{x:h,y:120}],backgroundColor:"rgba(255, 165, 0, 0.5)",borderColor:L?"rgba(255, 165, 0, 1)":"rgba(255, 165, 0, 0.7)",borderWidth:L?3:1,borderDash:[5,5],pointRadius:0,showLine:!0,tension:0}),a.push({label:"Current Level",data:[{x:125,y:d},{x:8e3,y:d}],backgroundColor:"rgba(255, 165, 0, 0.5)",borderColor:L?"rgba(255, 165, 0, 1)":"rgba(255, 165, 0, 0.7)",borderWidth:L?3:1,borderDash:[5,5],pointRadius:0,showLine:!0,tension:0}),a.push({label:"Current Position",data:[{x:h,y:d}],backgroundColor:L?"rgba(255, 165, 0, 1)":"rgba(255, 165, 0, 0.7)",borderColor:L?"rgb(255, 165, 0)":"rgba(255, 100, 0, 0.7)",pointStyle:"circle",pointRadius:L?9:7,borderWidth:2,showLine:!1})),{datasets:a}},u={responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"logarithmic",position:"bottom",title:{display:!0,text:"Frequency (Hz)"},ticks:{callback:function(a,c){const f=Number(a);return vs.includes(f)?f.toString():""},autoSkip:!1,maxRotation:0},min:125,max:8e3,grid:{display:!0,color:a=>Ie.includes(a.tick.value)?"rgba(0, 0, 0, 0.1)":"rgba(0, 0, 0, 0)"}},y:{type:"linear",reverse:!0,title:{display:!0,text:"Hearing Level (dB HL)"},min:-10,max:120,ticks:{stepSize:10,padding:8,autoSkip:!1,callback:function(a,c){return Number(a)+" dB"}},grid:{color:a=>a.tick.value===0?"rgba(0, 0, 0, 0.5)":a.tick.value%10===0?"rgba(0, 0, 0, 0.2)":"rgba(0, 0, 0, 0.1)",drawTicks:!0,tickLength:10}}},plugins:{legend:{display:!1,position:"bottom"},title:{display:!!s,text:s},tooltip:{callbacks:{label:a=>{const c=a.raw;return`${a.dataset.label}: ${c.x} Hz, ${c.y} dB HL`}}}}},i=a=>{if(!x||!v||!k.current||p)return;const c=k.current,g=c.canvas.getBoundingClientRect(),j=a.clientX-g.left,$=a.clientY-g.top,C=c.scales.x,E=c.scales.y;if(!C||!E)return;const W=C.getValueForPixel(j),M=E.getValueForPixel($);if(W===void 0||M===void 0)return;const V=Ie.reduce((J,U)=>Math.abs(U-W)<Math.abs(J-W)?U:J),Z=Math.round(M/5)*5,F=Math.max(-10,Math.min(120,Z));v(V,F)};return e.jsx(y,{sx:{flexGrow:1,position:"relative",height:"100%",width:"100%",cursor:x&&!p?"crosshair":"default"},children:e.jsx(Et,{data:m(),options:u,ref:k,onClick:i})})},xe=({children:r,value:t,index:n,...o})=>e.jsx("div",{role:"tabpanel",hidden:t!==n,id:`results-tabpanel-${n}`,"aria-labelledby":`results-tab-${n}`,...o,children:t===n&&e.jsx(y,{sx:{p:3},children:r})}),Ss=({session:r,onNewTest:t})=>{const[n,o]=S.useState(0),[s,l]=S.useState(!1);S.useRef(null),S.useRef(null);const h=oe(),d=r.results;if(!d)return e.jsxs(y,{sx:{p:3},children:[e.jsx(K,{severity:"error",sx:{mb:3},children:"Test results are missing or incomplete. Please try running the test again."}),e.jsx(R,{variant:"contained",onClick:t,children:"Return to Patient Selection"})]});const p=Se.getPatientById(r.patientId),v=()=>{if(!p)return{accuracy:0,exactMatch:0,within5dB:0,within10dB:0,missedThresholds:0};if(!d||!d.userThresholds)return console.error("Missing results or userThresholds:",d),{accuracy:0,exactMatch:0,within5dB:0,within10dB:0,missedThresholds:0};const u=d.userThresholds,i=p.thresholds;let a=0,c=0,f=0,g=0;u.forEach(C=>{const E=i.find(W=>W.frequency===C.frequency&&W.ear===C.ear&&W.testType===C.testType);if(E&&C.responseStatus==="threshold"&&E.responseStatus==="threshold"){const W=Math.abs(C.hearingLevel-E.hearingLevel);g++,W===0?(a++,c++,f++):W<=5?(c++,f++):W<=10&&f++}});const j=i.filter(C=>C.responseStatus==="threshold").length,$=u.filter(C=>C.responseStatus==="threshold").length;return{accuracy:g>0?Math.round(c/g*100):0,exactMatch:g>0?Math.round(a/g*100):0,within5dB:g>0?Math.round(c/g*100):0,within10dB:g>0?Math.round(f/g*100):0,missedThresholds:j-$}};let x;try{x=v()}catch(u){console.error("Error calculating metrics:",u),x={accuracy:0,exactMatch:0,within5dB:0,within10dB:0,missedThresholds:0}}const k=(u,i)=>{o(i)},L=async()=>{l(!0);try{const u=document.getElementById("test-results-container");if(!u){console.error("Results element not found"),l(!1);return}const i=await zt(u,{scale:2}),a=i.toDataURL("image/png"),c=new Dt({orientation:"portrait",unit:"mm",format:"a4"}),f=c.internal.pageSize.getWidth(),g=c.internal.pageSize.getHeight(),j=i.width,$=i.height,C=Math.min(f/j,g/$),E=(f-j*C)/2;c.addImage(a,"PNG",E,10,j*C,$*C),c.save(`audiometry_results_${new Date().toISOString().slice(0,10)}.pdf`)}catch(u){console.error("Error exporting to PDF:",u)}l(!1)},m=(u=>u>=90?{color:"success",label:"Excellent",icon:e.jsx(De,{})}:u>=75?{color:"info",label:"Good",icon:e.jsx(Lt,{})}:u>=60?{color:"warning",label:"Fair",icon:e.jsx(wt,{})}:{color:"error",label:"Needs Improvement",icon:e.jsx(Tt,{})})(x.accuracy);return e.jsx(H,{elevation:3,sx:{borderRadius:2,maxWidth:1200,mx:"auto"},id:"test-results-container",children:e.jsxs(y,{sx:{p:{xs:1,sm:2,md:3},mb:4},children:[e.jsx(b,{variant:"h4",gutterBottom:!0,children:"Test Results"}),e.jsxs(b,{variant:"subtitle1",color:"text.secondary",gutterBottom:!0,children:[p?.name," | ",new Date(d.timestamp).toLocaleString()]}),e.jsx(le,{sx:{my:2}}),e.jsxs(y,{sx:{width:"100%"},children:[e.jsx(y,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(vt,{value:n,onChange:k,"aria-label":"results tabs",children:[e.jsx(pe,{label:"Overview",id:"results-tab-0","aria-controls":"results-tabpanel-0"}),e.jsx(pe,{label:"Audiogram",id:"results-tab-1","aria-controls":"results-tabpanel-1"}),e.jsx(pe,{label:"Technique Analysis",id:"results-tab-2","aria-controls":"results-tabpanel-2"})]})}),e.jsx(xe,{value:n,index:0,children:e.jsxs(y,{sx:{display:"flex",flexDirection:{xs:"column",md:"row"},gap:3},children:[e.jsxs(y,{sx:{flex:1},children:[e.jsxs(H,{elevation:2,sx:{p:2,mb:3,bgcolor:h.palette.mode==="dark"?h.palette.background.paper:"#f8f9fa"},children:[e.jsx(b,{variant:"h6",gutterBottom:!0,children:"Test Summary"}),e.jsxs(b,{variant:"body2",gutterBottom:!0,children:[e.jsx("strong",{children:"Patient ID:"})," ",r.patientId]}),e.jsxs(b,{variant:"body2",gutterBottom:!0,children:[e.jsx("strong",{children:"Test Duration:"})," ",d.testDuration," seconds"]}),e.jsxs(b,{variant:"body2",gutterBottom:!0,children:[e.jsx("strong",{children:"Tested Frequencies:"})," ",d.userThresholds.filter(u=>u.responseStatus==="threshold").length]}),e.jsxs(b,{variant:"body2",gutterBottom:!0,children:[e.jsx("strong",{children:"Hearing Loss Type:"})," ",p?.hearingLossType.replace("_"," ")]})]}),e.jsxs(H,{elevation:2,sx:{p:2,mb:3},children:[e.jsxs(y,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(b,{variant:"h6",children:"Accuracy Rating"}),e.jsx(P,{label:m.label,color:m.color,icon:m.icon,sx:{fontWeight:"bold"}})]}),e.jsx(Te,{children:e.jsx(ae,{size:"small",children:e.jsxs(ce,{children:[e.jsxs(Y,{children:[e.jsx(B,{children:e.jsx("strong",{children:"Overall Accuracy"})}),e.jsxs(B,{align:"right",children:[x.accuracy,"%"]})]}),e.jsxs(Y,{children:[e.jsx(B,{children:"Exact Matches"}),e.jsxs(B,{align:"right",children:[x.exactMatch,"%"]})]}),e.jsxs(Y,{children:[e.jsx(B,{children:"Within 5 dB"}),e.jsxs(B,{align:"right",children:[x.within5dB,"%"]})]}),e.jsxs(Y,{children:[e.jsx(B,{children:"Within 10 dB"}),e.jsxs(B,{align:"right",children:[x.within10dB,"%"]})]}),e.jsxs(Y,{children:[e.jsx(B,{children:"Missed Thresholds"}),e.jsx(B,{align:"right",children:x.missedThresholds})]})]})})})]})]}),e.jsxs(y,{sx:{flex:1},children:[d.technicalErrors.length>0&&e.jsxs(K,{severity:"warning",sx:{mb:3},children:[e.jsx(ge,{children:"Technical Errors Detected"}),e.jsx("ul",{style:{margin:0,paddingLeft:20},children:d.technicalErrors.map((u,i)=>e.jsx("li",{children:u},i))})]}),e.jsxs(H,{elevation:2,sx:{p:2},children:[e.jsx(b,{variant:"h6",gutterBottom:!0,children:"Educational Notes"}),e.jsxs(b,{variant:"body2",paragraph:!0,children:[p?.hearingLossType==="normal"&&"This patient has normal hearing across all frequencies tested. Key indicators include thresholds better than 25dB HL across the spectrum.",p?.hearingLossType==="conductive"&&"This patient shows a conductive hearing loss pattern, characterized by air-bone gaps. This indicates a problem in the outer or middle ear affecting sound transmission.",p?.hearingLossType==="sensorineural"&&"This patient has a sensorineural hearing loss pattern. Air and bone conduction thresholds are similar, indicating the loss is in the cochlea or neural pathway.",p?.hearingLossType==="mixed"&&"This patient shows a mixed hearing loss with both conductive and sensorineural components. Note the elevated bone conduction thresholds and additional air-bone gaps.",p?.hearingLossType==="asymmetrical"&&"This patient has asymmetrical hearing loss with different thresholds between the left and right ears. This pattern requires additional diagnostic testing and may indicate unilateral pathology."]}),e.jsx(b,{variant:"subtitle2",gutterBottom:!0,children:"Hughson-Westlake Protocol Reminder:"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Begin testing at 1000 Hz in the better ear"}),e.jsx("li",{children:"Present tones for 1-2 seconds with varied intervals"}),e.jsx("li",{children:"Use 10 dB steps down after response until no response"}),e.jsx("li",{children:"Use 5 dB steps up until response"}),e.jsx("li",{children:"Threshold is the lowest level with 2 out of 3 responses"}),e.jsx("li",{children:"Proceed with 2000, 4000, 8000, then 500, 250 Hz"}),e.jsx("li",{children:"Retest 1000 Hz to verify reliability"})]})]})]})]})}),e.jsx(xe,{value:n,index:1,children:e.jsxs(y,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(js,{thresholds:d.userThresholds,compareThresholds:p?.thresholds,height:700,width:800,title:"Test Results vs. Actual Thresholds"}),e.jsx(b,{variant:"subtitle2",color:"text.secondary",sx:{mt:2},children:"Solid lines: Your test results | Dashed lines: Actual patient thresholds"}),e.jsxs(K,{severity:"info",sx:{mt:3,width:"100%"},children:[e.jsx(ge,{children:"Audiogram Interpretation Guide"}),e.jsxs(b,{variant:"body2",children:[e.jsx("strong",{children:"Normal hearing:"})," Thresholds better than 25 dB HL",e.jsx("br",{}),e.jsx("strong",{children:"Mild hearing loss:"})," 26-40 dB HL",e.jsx("br",{}),e.jsx("strong",{children:"Moderate hearing loss:"})," 41-55 dB HL",e.jsx("br",{}),e.jsx("strong",{children:"Moderately severe hearing loss:"})," 56-70 dB HL",e.jsx("br",{}),e.jsx("strong",{children:"Severe hearing loss:"})," 71-90 dB HL",e.jsx("br",{}),e.jsx("strong",{children:"Profound hearing loss:"})," Greater than 90 dB HL"]})]})]})}),e.jsxs(xe,{value:n,index:2,children:[e.jsx(Te,{component:H,elevation:2,children:e.jsxs(ae,{sx:{minWidth:650},children:[e.jsx(ve,{children:e.jsxs(Y,{children:[e.jsx(B,{children:"Frequency (Hz)"}),e.jsx(B,{children:"Ear"}),e.jsx(B,{children:"Test Type"}),e.jsx(B,{children:"Your Result (dB HL)"}),e.jsx(B,{children:"Actual Threshold (dB HL)"}),e.jsx(B,{children:"Difference"}),e.jsx(B,{children:"Status"})]})}),e.jsx(ce,{children:d.userThresholds.map((u,i)=>{const a=p?.thresholds.find(g=>g.frequency===u.frequency&&g.ear===u.ear&&g.testType===u.testType);let c=0,f="Untested";return a&&u.responseStatus==="threshold"&&a.responseStatus==="threshold"?(c=Math.abs(u.hearingLevel-a.hearingLevel),c===0?f="Exact Match":c<=5?f="Within 5 dB":c<=10?f="Within 10 dB":f="Significant Deviation"):u.responseStatus==="threshold"&&(f="Tested"),e.jsxs(Y,{children:[e.jsx(B,{children:u.frequency}),e.jsx(B,{children:u.ear==="left"?"Left":"Right"}),e.jsx(B,{children:u.testType.replace("_"," ")}),e.jsx(B,{children:u.hearingLevel}),e.jsx(B,{children:a?.hearingLevel||"N/A"}),e.jsx(B,{children:u.responseStatus==="threshold"?`${c} dB`:"N/A"}),e.jsx(B,{children:e.jsx(P,{label:f,size:"small",color:f==="Exact Match"?"success":f==="Within 5 dB"?"primary":f==="Within 10 dB"?"info":f==="Significant Deviation"?"error":"default"})})]},i)})})]})}),d.technicalErrors.length>0&&e.jsxs(H,{elevation:2,sx:{mt:3,p:2},children:[e.jsx(b,{variant:"h6",gutterBottom:!0,children:"Technical Errors Analysis"}),e.jsx("ul",{children:d.technicalErrors.map((u,i)=>e.jsx("li",{children:e.jsx(b,{variant:"body2",children:u})},i))}),e.jsxs(K,{severity:"info",sx:{mt:2},children:[e.jsx(ge,{children:"Improvement Suggestions"}),e.jsxs(b,{variant:"body2",children:[d.technicalErrors.some(u=>u.includes("Skipped"))&&`• Ensure all frequencies are tested for complete assessment
`,d.technicalErrors.some(u=>u.includes("Insufficient"))&&`• Collect at least 3 responses at threshold level
`,d.technicalErrors.some(u=>u.includes("too high"))&&`• Start at more appropriate levels (typically 30-40 dB HL)
`,"Practice proper step sizes: 10 dB down after response, 5 dB up until response"]})]})]})]})]}),e.jsx(le,{sx:{my:3}}),e.jsxs(Pe,{direction:{xs:"column",sm:"row"},spacing:2,justifyContent:"space-between",children:[e.jsx(y,{children:e.jsx(R,{variant:"contained",color:"primary",onClick:t,children:"Start New Test"})}),e.jsxs(y,{sx:{display:"flex",gap:2},children:[e.jsx(R,{variant:"outlined",startIcon:e.jsx(jt,{}),disabled:!0,children:"Share Results"}),e.jsx(R,{variant:"outlined",startIcon:e.jsx(St,{}),onClick:L,disabled:s,children:s?"Exporting...":"Export PDF"})]})]})]})})},ks=()=>{const[r,t]=S.useState([]),[n,o]=S.useState([]),[s,l]=S.useState(null),[h,d]=S.useState(""),[p,v]=S.useState("all"),[x,k]=S.useState("all"),[L,w]=S.useState(!1),[m,u]=S.useState(null),[i,a]=S.useState(1),[c]=S.useState(6),[f,g]=S.useState(!1),j=oe();Re(j.breakpoints.down("md")),S.useEffect(()=>{const q=Se.getAllPatients();t(q),o(q)},[]),S.useEffect(()=>{let q=r;h&&(q=q.filter(I=>I.name.toLowerCase().includes(h.toLowerCase())||I.description.toLowerCase().includes(h.toLowerCase())||I.id.toLowerCase().includes(h.toLowerCase()))),p!=="all"&&(q=q.filter(I=>I.difficulty===p)),x!=="all"&&(q=q.filter(I=>I.hearingLossType===x)),o(q),a(1)},[h,p,x,r]);const $=q=>{d(q.target.value)},C=q=>{v(q.target.value)},E=q=>{k(q.target.value)},W=q=>{l(q)},M=()=>{w(!0),u(null)},V=()=>{w(!1),u(null)},Z=q=>{w(!1),u(q)},F=()=>{u(null),l(null)},J=(q,I)=>{a(I)},U=i*c,X=U-c,re=n.slice(X,U),ee=Math.ceil(n.length/c),T=()=>{d(""),v("all"),k("all"),g(!1)};return m?e.jsx(fe,{maxWidth:"lg",sx:{py:4},children:e.jsx(Ss,{session:m,onNewTest:F})}):L&&s?e.jsx(fe,{maxWidth:"lg",sx:{py:4},children:e.jsx(bs,{patient:s,onComplete:Z,onCancel:V})}):e.jsxs(fe,{maxWidth:"lg",sx:{mt:{xs:2,md:4},mb:6},children:[e.jsx(b,{variant:"h4",gutterBottom:!0,children:"Virtual Patients"}),e.jsx(b,{variant:"body1",paragraph:!0,color:"text.secondary",children:"Select a virtual patient to practice your audiometry skills. Each patient has a unique hearing profile that simulates different types of hearing loss."}),e.jsx(y,{sx:{mb:{xs:2,md:4}},children:e.jsxs(D,{container:!0,spacing:{xs:1,md:2},alignItems:"center",children:[e.jsx(D,{item:!0,xs:12,md:6,children:e.jsx(Ct,{fullWidth:!0,variant:"outlined",placeholder:"Search patients...",value:h,onChange:$,InputProps:{startAdornment:e.jsx(qt,{position:"start",children:e.jsx(Bt,{})})},size:"small",sx:{mb:{xs:1,md:0}}})}),e.jsx(D,{item:!0,xs:12,md:6,children:e.jsxs(y,{sx:{display:"flex",gap:{xs:1,md:2},justifyContent:{xs:"space-between",md:"flex-end"},flexWrap:"wrap"},children:[e.jsx(R,{variant:"outlined",startIcon:e.jsx(kt,{}),onClick:()=>g(!0),size:"small",sx:{flex:{xs:1,sm:"initial"}},children:"Filters"}),s?e.jsx(R,{variant:"contained",color:"primary",startIcon:e.jsx(Ce,{}),onClick:M,size:"small",sx:{flex:{xs:1,sm:"initial"}},children:"Start Testing"}):e.jsx(R,{variant:"outlined",color:"secondary",startIcon:e.jsx($t,{}),disabled:!0,size:"small",sx:{flex:{xs:1,sm:"initial"}},children:"Add Patient"})]})})]})}),(p!=="all"||x!=="all")&&e.jsx(y,{sx:{mb:3},children:e.jsxs(Pe,{direction:{xs:"column",sm:"row"},spacing:1,alignItems:{xs:"flex-start",sm:"center"},sx:{flexWrap:"wrap",gap:1},children:[e.jsx(b,{variant:"body2",children:"Active Filters:"}),e.jsxs(y,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:[p!=="all"&&e.jsx(P,{label:`Difficulty: ${p}`,onDelete:()=>v("all"),size:"small",color:"primary"}),x!=="all"&&e.jsx(P,{label:`Type: ${x.replace("_"," ")}`,onDelete:()=>k("all"),size:"small",color:"secondary"}),e.jsx(R,{size:"small",onClick:T,children:"Clear All"})]})]})}),e.jsxs(Me,{open:f,onClose:()=>g(!1),fullWidth:!0,maxWidth:"xs",children:[e.jsx(Fe,{children:"Filter Patients"}),e.jsxs(Ne,{sx:{pt:1},children:[e.jsxs(qe,{fullWidth:!0,margin:"normal",children:[e.jsx(Be,{children:"Difficulty Level"}),e.jsxs(ke,{value:p,onChange:C,label:"Difficulty Level",children:[e.jsx(_,{value:"all",children:"All Levels"}),e.jsx(_,{value:"beginner",children:"Beginner"}),e.jsx(_,{value:"intermediate",children:"Intermediate"}),e.jsx(_,{value:"advanced",children:"Advanced"})]})]}),e.jsxs(qe,{fullWidth:!0,margin:"normal",children:[e.jsx(Be,{children:"Hearing Loss Type"}),e.jsxs(ke,{value:x,onChange:E,label:"Hearing Loss Type",children:[e.jsx(_,{value:"all",children:"All Types"}),e.jsx(_,{value:"normal",children:"Normal Hearing"}),e.jsx(_,{value:"conductive",children:"Conductive"}),e.jsx(_,{value:"sensorineural",children:"Sensorineural"}),e.jsx(_,{value:"mixed",children:"Mixed"}),e.jsx(_,{value:"asymmetrical",children:"Asymmetrical"})]})]})]}),e.jsxs(Oe,{children:[e.jsx(R,{onClick:T,children:"Reset"}),e.jsx(R,{onClick:()=>g(!1),color:"primary",children:"Apply"})]})]}),e.jsx(le,{sx:{mb:{xs:2,md:4}}}),n.length>0?e.jsxs(e.Fragment,{children:[e.jsx(D,{container:!0,spacing:{xs:1,sm:2,md:3},children:re.map(q=>e.jsx(D,{item:!0,xs:12,sm:6,md:4,children:e.jsx(Xt,{patient:q,onSelect:W,selected:s?.id===q.id})},q.id))}),e.jsx(y,{sx:{display:"flex",justifyContent:"center",mt:{xs:2,md:4}},children:e.jsx(It,{count:ee,page:i,onChange:J,color:"primary",showFirstButton:!0,showLastButton:!0,size:"small"})})]}):e.jsxs(H,{elevation:0,sx:{p:{xs:2,md:4},textAlign:"center",bgcolor:j.palette.mode==="dark"?G(j.palette.background.paper,.6):"#f5f5f5",borderRadius:2},children:[e.jsx(b,{variant:"h6",gutterBottom:!0,children:"No matching patients found"}),e.jsx(b,{variant:"body2",color:"text.secondary",children:"Try adjusting your search criteria or filters to find a patient."}),e.jsx(R,{variant:"outlined",sx:{mt:2},onClick:T,children:"Clear All Filters"})]}),s&&e.jsxs(H,{elevation:3,sx:{mt:{xs:2,md:4},p:{xs:2,md:3},bgcolor:j.palette.mode==="dark"?j.palette.background.paper:"#f9f9f9",borderRadius:2,border:`1px solid ${j.palette.divider}`},children:[e.jsxs(b,{variant:"h5",gutterBottom:!0,children:["Selected Patient: ",s.name]}),e.jsx(b,{variant:"body1",paragraph:!0,children:s.description}),e.jsxs(y,{sx:{display:"flex",gap:1,mb:2,flexWrap:"wrap"},children:[e.jsx(P,{label:`Difficulty: ${s.difficulty}`,color:s.difficulty==="beginner"?"success":s.difficulty==="intermediate"?"warning":"error"}),e.jsx(P,{label:`Type: ${s.hearingLossType.replace("_"," ")}`,color:"secondary"})]}),e.jsx(R,{variant:"contained",color:"primary",startIcon:e.jsx(Ce,{}),onClick:M,size:"large",fullWidth:!0,sx:{display:{xs:"flex",md:"inline-flex"},width:{xs:"100%",md:"auto"}},children:"Begin Audiometry Test"})]})]})};export{ks as default};
