var We=Object.defineProperty;var Ue=(s,r,i)=>r in s?We(s,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[r]=i;var P=(s,r,i)=>(Ue(s,typeof r!="symbol"?r+"":r,i),i);import{j as e,B as p,d as t,U as v,G as I,b1 as O,b2 as D,p as y,m as L,W as _,b5 as ye,a3 as qe,I as he,a1 as He,a4 as S,u as Ve,bs as $e,aG as Ye,F as ve,Z as C,$ as T,D as Xe,E as Je,H as Qe,aP as Ke,aQ as ce,aq as je,ar as fe,as as be}from"./vendor-mui-BsgQ3_Os.js";import{r as j}from"./vendor-react-5UJDq-bj.js";import{f as Ze,C as et,a as tt,L as st,b as rt,P as it,c as nt,p as at,d as ot,e as lt}from"./vendor-charts-CVJ2HOFM.js";var A=(s=>(s.OCCLUDED="occluded",s.SMALL_VENT="small_vent",s.MEDIUM_VENT="medium_vent",s.LARGE_VENT="large_vent",s.OPEN_DOME="open_dome",s))(A||{}),E=(s=>(s.TOO_SHALLOW="too_shallow",s.TOO_DEEP="too_deep",s.CORRECT="correct",s.NOT_INSERTED="not_inserted",s))(E||{});class ct{constructor(){P(this,"audioContext",null);P(this,"analyzer",null);P(this,"oscillator",null);P(this,"gainNode",null);P(this,"currentSession",null);P(this,"virtualHearingAids",new Map);P(this,"sampleRate",44100);P(this,"isPlaying",!1);this.initializeAudioContext(),this.loadVirtualHearingAids()}initializeAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyzer=this.audioContext.createAnalyser(),this.analyzer.fftSize=2048}catch(r){console.error("Failed to initialize audio context for REM",r)}}loadVirtualHearingAids(){[{id:"ha1",name:"Premium BTE",manufacturer:"AudioCorp",type:"BTE",maxGain:70,maxOutput:130,channels:20,features:["Feedback cancellation","Noise reduction","Directional mic"],defaultSettings:{125:10,250:15,500:20,750:25,1e3:30,1500:35,2e3:40,3e3:45,4e3:40,6e3:35,8e3:30}},{id:"ha2",name:"Standard RIC",manufacturer:"HearWell",type:"RIC",maxGain:60,maxOutput:120,channels:12,features:["Feedback cancellation","Noise reduction"],defaultSettings:{125:5,250:10,500:15,750:20,1e3:25,1500:30,2e3:35,3e3:40,4e3:35,6e3:30,8e3:25}},{id:"ha3",name:"Economy CIC",manufacturer:"SoundClear",type:"CIC",maxGain:50,maxOutput:110,channels:8,features:["Feedback cancellation"],defaultSettings:{125:0,250:5,500:10,750:15,1e3:20,1500:25,2e3:30,3e3:35,4e3:30,6e3:25,8e3:20}}].forEach(i=>{this.virtualHearingAids.set(i.id,i)})}createSession(r,i){const c={id:this.generateUniqueId(),patientId:r,hearingAidId:i,startTime:new Date().toISOString(),completed:!1,probeTubePosition:E.NOT_INSERTED,ventType:A.OCCLUDED,measurements:[],targets:[],currentStep:"REUR",errors:[],accuracy:0};return this.currentSession=c,c}generateUniqueId(){return Date.now().toString(36)+Math.random().toString(36).substring(2)}positionProbeTube(r){if(!this.currentSession)throw new Error("No active session");let i;return r<20?i=E.TOO_SHALLOW:r>30?i=E.TOO_DEEP:i=E.CORRECT,this.currentSession.probeTubePosition=i,i}performMeasurement(r,i,c,d){return this.currentSession?this.currentSession.probeTubePosition!==E.CORRECT?Promise.reject(new Error("Probe tube not correctly positioned")):new Promise(g=>{const l=this.simulateMeasurement(r,i,c,d),u={type:r,ear:i,signalType:c,inputLevel:d,measurementPoints:l,timestamp:new Date().toISOString()};this.currentSession&&(this.currentSession.measurements.push(u),this.currentSession.currentStep=r),g(u)}):Promise.reject(new Error("No active session"))}simulateMeasurement(r,i,c,d){if(!this.currentSession)throw new Error("No active session");const g=[],l=[125,250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3],u=this.virtualHearingAids.get(this.currentSession.hearingAidId);if(!u)throw new Error("Hearing aid not found");return l.forEach(x=>{let m=0;const a=Math.random()*5-2.5;switch(r){case"REUR":x<1e3?m=0+a:x<2e3?m=3+a:x<3e3?m=10+a:x<6e3?m=5+a:m=3+a;break;case"REOR":let n=0;if(this.currentSession&&this.currentSession.ventType)switch(this.currentSession.ventType){case A.OCCLUDED:n=0;break;case A.SMALL_VENT:n=.25;break;case A.MEDIUM_VENT:n=.5;break;case A.LARGE_VENT:n=.75;break;case A.OPEN_DOME:n=.9;break}let h=0;x<1e3?h=0+a:x<2e3?h=3+a:x<3e3?h=10+a:x<6e3?h=5+a:h=3+a;let f=0;x<500?f=5+a:x<1e3?f=2+a:f=-3+a,m=h*n+f*(1-n);break;case"REAR":const w=u.defaultSettings[x]||0,W=(d-65)*.5;m=w+W+a;break;case"REIG":m=(u.defaultSettings[x]||0)+a;break;case"RECD":x<500?m=3+a:x<1e3?m=5+a:x<4e3?m=8+a:m=12+a;break;case"RESR":m=Math.min(u.maxOutput-d,u.maxGain)+a;break}g.push({frequency:x,gain:Math.round(m*10)/10})}),g}generateTargets(r,i){if(!this.currentSession)throw new Error("No active session");const c="right",d=[],g={type:"REAR",ear:c,patientId:r,prescriptionMethod:i,targetPoints:[]},l={type:"REIG",ear:c,patientId:r,prescriptionMethod:i,targetPoints:[]},u=[125,250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3],m={"NAL-NL2":{125:5,250:10,500:15,750:20,1e3:25,1500:30,2e3:35,3e3:40,4e3:35,6e3:30,8e3:25},DSL:{125:8,250:13,500:18,750:23,1e3:28,1500:33,2e3:38,3e3:43,4e3:38,6e3:33,8e3:28},"NAL-NL1":{125:3,250:8,500:13,750:18,1e3:23,1500:28,2e3:33,3e3:38,4e3:33,6e3:28,8e3:23},custom:{125:10,250:15,500:20,750:25,1e3:30,1500:35,2e3:40,3e3:45,4e3:40,6e3:35,8e3:30}}[i];return u.forEach(a=>{const n=m[a];g.targetPoints.push({frequency:a,gain:n}),l.targetPoints.push({frequency:a,gain:n-5})}),d.push(g,l),this.currentSession.targets=d,d}calculateAccuracy(r,i){if(r.ear!==i.ear||r.type!==i.type&&!(r.type==="REAR"&&i.type==="REIG"))return 0;let c=0,d=0;if(r.measurementPoints.forEach(l=>{const u=i.targetPoints.find(x=>x.frequency===l.frequency);if(u){const x=Math.abs(l.gain-u.gain);let m,a;l.frequency>=1e3&&l.frequency<=4e3?(m=3,a=3):l.frequency<1e3?(m=5,a=2):(m=8,a=1);let n;x<=m?n=100:n=Math.max(0,100-(x-m)/(m*2)*100),c+=n*a,d+=a}}),d===0)return 0;const g=c/d;return this.currentSession&&(this.currentSession.accuracy=g),g}playTestSignal(r,i,c){if(this.audioContext||this.initializeAudioContext(),!this.audioContext){console.error("Audio context not available");return}this.stopTestSignal();try{switch(this.oscillator=this.audioContext.createOscillator(),this.gainNode=this.audioContext.createGain(),r){case"pure_tone_sweep":this.oscillator.type="sine",this.oscillator.frequency.value=1e3;const l=this.audioContext.currentTime;this.oscillator.frequency.setValueAtTime(125,l),this.oscillator.frequency.exponentialRampToValueAtTime(8e3,l+5);break;case"speech_noise":case"pink_noise":case"white_noise":case"ISTS_noise":this.oscillator.disconnect(),this.oscillator=null;const u=2*this.audioContext.sampleRate,x=this.audioContext.createBuffer(1,u,this.audioContext.sampleRate),m=x.getChannelData(0);for(let n=0;n<u;n++)m[n]=Math.random()*2-1;const a=this.audioContext.createBufferSource();a.buffer=x,a.loop=!0,a.connect(this.gainNode),a.start();break}const d=Math.pow(10,(i-70)/20);this.gainNode.gain.value=d;const g=this.audioContext.createStereoPanner();g.pan.value=c==="left"?-1:1,this.oscillator&&this.oscillator.connect(this.gainNode),this.gainNode.connect(g),g.connect(this.audioContext.destination),this.oscillator&&this.oscillator.start(),this.isPlaying=!0}catch(d){console.error("Error playing test signal:",d)}}stopTestSignal(){try{this.oscillator&&(this.oscillator.stop(),this.oscillator.disconnect(),this.oscillator=null),this.gainNode&&(this.gainNode.disconnect(),this.gainNode=null),this.isPlaying=!1}catch(r){console.error("Error stopping test signal:",r)}}getHearingAids(){return Array.from(this.virtualHearingAids.values())}dispose(){this.stopTestSignal(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.analyzer=null,this.currentSession=null}}const de=["Setup Equipment","Position Probe Tube","REUR Measurement","REOR Measurement","REAR Measurement","REIG Calculation","Compare to Target","Adjust Frequency Response"],dt=[{id:"p1",name:"John Smith",age:68,hearingLoss:"Moderate-to-severe sensorineural"},{id:"p2",name:"Mary Johnson",age:75,hearingLoss:"Mild-to-moderate sensorineural"},{id:"p3",name:"Robert Davis",age:52,hearingLoss:"Moderate conductive"}],ht=[125,250,500,750,1e3,1500,2e3,3e3,4e3,6e3,8e3],ut=({selectedPatient:s,setSelectedPatient:r,selectedHearingAid:i,setSelectedHearingAid:c,hearingAids:d,selectedEar:g,setSelectedEar:l,startNewSession:u})=>{const x=n=>{r(n.target.value)},m=n=>{c(n.target.value)},a=n=>{l(n.target.value)};return e.jsxs(p,{children:[e.jsx(t,{variant:"h6",children:"Setup Equipment"}),e.jsxs(v,{container:!0,spacing:3,sx:{mt:2},children:[e.jsx(v,{item:!0,xs:12,md:6,children:e.jsxs(I,{fullWidth:!0,children:[e.jsx(O,{children:"Select Patient"}),e.jsx(D,{value:s,onChange:x,label:"Select Patient",children:dt.map(n=>e.jsxs(y,{value:n.id,children:[n.name," - ",n.age," y/o - ",n.hearingLoss]},n.id))})]})}),e.jsx(v,{item:!0,xs:12,md:6,children:e.jsxs(I,{fullWidth:!0,children:[e.jsx(O,{children:"Select Hearing Aid"}),e.jsx(D,{value:i,onChange:m,label:"Select Hearing Aid",children:d.map(n=>e.jsxs(y,{value:n.id,children:[n.manufacturer," ",n.name," (",n.type,")"]},n.id))})]})}),e.jsx(v,{item:!0,xs:12,md:6,children:e.jsxs(I,{fullWidth:!0,children:[e.jsx(O,{children:"Select Ear"}),e.jsxs(D,{value:g,onChange:a,label:"Select Ear",children:[e.jsx(y,{value:"left",children:"Left Ear"}),e.jsx(y,{value:"right",children:"Right Ear"})]})]})}),e.jsx(v,{item:!0,xs:12,children:e.jsx(L,{variant:"contained",color:"primary",onClick:u,disabled:!s||!i,children:"Initialize Setup"})})]})]})},xt=({probeTubeDepth:s,setProbeTubeDepth:r,probePosition:i,handlePositionProbeTube:c})=>e.jsxs(p,{children:[e.jsx(t,{variant:"h6",children:"Position Probe Tube"}),e.jsxs(_,{sx:{p:{xs:2,sm:3},mt:2},children:[e.jsx(t,{gutterBottom:!0,children:"Adjust probe tube depth (mm). The correct insertion depth is between 20mm and 30mm."}),e.jsx(ye,{value:s,onChange:(d,g)=>r(g),step:1,marks:[{value:0,label:"0mm"},{value:10,label:"10mm"},{value:20,label:"20mm (min)"},{value:30,label:"30mm (max)"},{value:40,label:"40mm"}],min:0,max:40,valueLabelDisplay:"on"}),e.jsxs(p,{sx:{mt:2,display:"flex",gap:2},children:[e.jsx(L,{variant:"contained",color:"primary",onClick:c,children:"Check Position"}),e.jsx(qe,{title:"Correct position is typically 25-28mm from the tragus.",children:e.jsx(he,{children:e.jsx(He,{})})})]}),i!==E.NOT_INSERTED&&e.jsxs(S,{severity:i===E.CORRECT?"success":"error",sx:{mt:2},children:["Probe position: ",i.replace("_"," ")]})]})]});et.register(tt,st,rt,it,nt,at,ot,lt);const Z={REUR:"#2196F3",REOR:"#FF9800",REAR:"#4CAF50",REIG:"#9C27B0",RECD:"#F44336",RESR:"#795548"},ee=({measurements:s=null,measurement:r=null,target:i,title:c="Real Ear Measurement",showLegend:d=!0,height:g=400,width:l=800})=>{const u=Ve(),x=()=>{const a=["125","250","500","750","1000","1500","2000","3000","4000","6000","8000"],n=[];return r&&r.measurementPoints.length>0&&n.push({label:`${r.type} Measurement`,data:r.measurementPoints.map(h=>h.gain),borderColor:Z[r.type]||u.palette.primary.main,backgroundColor:"rgba(0, 0, 0, 0)",borderWidth:2,pointRadius:4,pointBackgroundColor:Z[r.type]||u.palette.primary.main,tension:.3}),s&&s.length>0&&s.forEach(h=>{h&&h.measurementPoints.length>0&&n.push({label:`${h.type} Measurement`,data:h.measurementPoints.map(f=>f.gain),borderColor:Z[h.type]||u.palette.primary.main,backgroundColor:"rgba(0, 0, 0, 0)",borderWidth:2,pointRadius:4,pointBackgroundColor:Z[h.type]||u.palette.primary.main,tension:.3})}),i&&i.targetPoints.length>0&&n.push({label:`${i.type} Target`,data:i.targetPoints.map(h=>h.gain),borderColor:u.palette.secondary.main,backgroundColor:"rgba(0, 0, 0, 0)",borderWidth:2,borderDash:[5,5],pointRadius:4,pointBackgroundColor:u.palette.secondary.main,tension:.3}),{labels:a,datasets:n}},m={responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"category",title:{display:!0,text:"Frequency (Hz)"}},y:{title:{display:!0,text:"Gain (dB)"},min:-10,max:80}},plugins:{legend:{display:d,position:"top"},title:{display:!!c,text:c},tooltip:{callbacks:{label:function(a){const n=a.dataIndex,h=["125","250","500","750","1000","1500","2000","3000","4000","6000","8000"];return`${a.dataset.label}: ${a.raw} dB at ${h[n]} Hz`}}}}};return e.jsx(p,{sx:{height:g,width:l,maxWidth:"100%"},children:!r&&!s?.length&&!i?e.jsx(t,{variant:"body1",align:"center",sx:{mt:8},children:"No measurement data available. Complete a measurement to see results."}):e.jsx(Ze,{data:x(),options:m})})},ue=({measurements:s})=>e.jsxs(p,{sx:{mt:2,display:"flex",flexDirection:"column"},children:[e.jsx(t,{variant:"subtitle1",gutterBottom:!0,children:"Completed Measurements:"}),e.jsx(p,{sx:{display:"flex",flexWrap:"wrap",gap:2},children:s.map(r=>e.jsxs(p,{sx:{display:"flex",alignItems:"center",bgcolor:"background.paper",p:1,borderRadius:1,border:"1px solid",borderColor:"divider"},children:[e.jsx(p,{sx:{width:16,height:16,bgcolor:r.type==="REUR"?"#2196F3":r.type==="REOR"?"#FF9800":r.type==="REAR"?"#4CAF50":r.type==="REIG"?"#9C27B0":r.type==="RECD"?"#F44336":"#795548",mr:1,borderRadius:"50%"}}),e.jsx(t,{variant:"body2",children:r.type})]},r.type))})]}),mt=({activeStep:s,measurementType:r,setMeasurementType:i,signalType:c,setSignalType:d,inputLevel:g,setInputLevel:l,isPlaying:u,playTestSignal:x,stopTestSignal:m,performMeasurement:a,isLoading:n,probePosition:h,allMeasurements:f,currentTarget:w,selectedVentType:W,setSelectedVentType:U})=>{const te=M=>{i(M.target.value)},se=M=>{d(M.target.value)},re=(M,B)=>{const V=Array.isArray(B)?B[0]:B,$=[50,55,60,65,70,75,80,85,90].reduce((G,Y)=>Math.abs(Y-V)<Math.abs(G-V)?Y:G);l($)},q=M=>{U(M.target.value)};return e.jsxs(p,{children:[e.jsxs(t,{variant:"h6",children:[r," Measurement"]}),e.jsx(_,{sx:{p:{xs:2,sm:3},mt:2},children:e.jsxs(v,{container:!0,spacing:3,children:[e.jsxs(v,{item:!0,xs:12,md:6,children:[e.jsxs(I,{fullWidth:!0,sx:{mb:2},children:[e.jsx(O,{children:"Measurement Type"}),e.jsxs(D,{value:r,onChange:te,label:"Measurement Type",children:[e.jsx(y,{value:"REUR",children:"REUR - Real Ear Unaided Response"}),e.jsx(y,{value:"REOR",children:"REOR - Real Ear Occluded Response"}),e.jsx(y,{value:"REAR",children:"REAR - Real Ear Aided Response"}),e.jsx(y,{value:"REIG",children:"REIG - Real Ear Insertion Gain"}),e.jsx(y,{value:"RECD",children:"RECD - Real Ear to Coupler Difference"}),e.jsx(y,{value:"RESR",children:"RESR - Real Ear Saturation Response"})]})]}),e.jsxs(I,{fullWidth:!0,sx:{mb:2},children:[e.jsx(O,{children:"Signal Type"}),e.jsxs(D,{value:c,onChange:se,label:"Signal Type",children:[e.jsx(y,{value:"pure_tone_sweep",children:"Pure Tone Sweep"}),e.jsx(y,{value:"speech_noise",children:"Speech Noise"}),e.jsx(y,{value:"pink_noise",children:"Pink Noise"}),e.jsx(y,{value:"white_noise",children:"White Noise"}),e.jsx(y,{value:"ISTS_noise",children:"ISTS Noise"})]})]}),e.jsx(t,{gutterBottom:!0,children:"Input Level (dB SPL)"}),e.jsx(ye,{value:g,onChange:re,step:5,marks:!0,min:50,max:90,valueLabelDisplay:"on"}),e.jsxs(p,{sx:{mt:3,display:"flex",gap:2},children:[e.jsx(L,{variant:"contained",color:"primary",startIcon:u?e.jsx($e,{}):e.jsx(Ye,{}),onClick:u?m:x,children:u?"Stop Signal":"Play Signal"}),e.jsx(L,{variant:"contained",color:"secondary",onClick:a,disabled:n||h!==E.CORRECT,children:n?e.jsxs(e.Fragment,{children:[e.jsx(ve,{size:24,sx:{mr:1}}),"Measuring..."]}):"Run Measurement"})]})]}),e.jsxs(v,{item:!0,xs:12,md:6,children:[e.jsxs(t,{variant:"subtitle1",gutterBottom:!0,children:["Information about ",r]}),e.jsxs(p,{sx:{p:2,bgcolor:"background.paper",borderRadius:1},children:[r==="REUR"&&e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",sx:{mb:2},children:"Real Ear Unaided Response measures the natural resonance of the ear canal without a hearing aid. This is an important baseline measurement."}),e.jsxs(S,{severity:"info",sx:{mb:1},children:[e.jsx(t,{variant:"body2",children:e.jsx("strong",{children:"Tips for proper REUR response:"})}),e.jsx(t,{variant:"body2",component:"div",children:e.jsxs("ul",{children:[e.jsx("li",{children:"The resonance peak should be around 2.7kHz-3kHz"}),e.jsx("li",{children:"The 6kHz response should not drop below 0 dB"}),e.jsx("li",{children:"Typical gain at peak should be around 10-15 dB"}),e.jsx("li",{children:"The response should be smooth without sharp peaks or valleys"})]})})]})]}),r==="REOR"&&e.jsxs(e.Fragment,{children:[e.jsx(t,{variant:"body2",sx:{mb:2},children:"Real Ear Occluded Response measures the response with the hearing aid in place but turned off. This shows the impact of blocking the ear canal."}),e.jsxs(I,{fullWidth:!0,sx:{mb:2},children:[e.jsx(O,{children:"Dome/Earmold Vent Type"}),e.jsxs(D,{value:W,onChange:q,label:"Dome/Earmold Vent Type",children:[e.jsx(y,{value:A.OCCLUDED,children:"Occluded (No Vent)"}),e.jsx(y,{value:A.SMALL_VENT,children:"Small Vent"}),e.jsx(y,{value:A.MEDIUM_VENT,children:"Medium Vent"}),e.jsx(y,{value:A.LARGE_VENT,children:"Large Vent"}),e.jsx(y,{value:A.OPEN_DOME,children:"Open Dome"})]})]}),e.jsx(S,{severity:"info",children:e.jsx(t,{variant:"body2",children:"Vent size affects the sound pressure at the ear drum. More open fittings (larger vents) will result in a response closer to REUR, while more closed fittings will show greater occlusion effect at low frequencies and more high-frequency attenuation."})})]}),r==="REAR"&&e.jsx(t,{variant:"body2",children:"Real Ear Aided Response measures the response with the hearing aid in place and turned on. This is compared with targets to verify the fitting."})]})]})]})}),e.jsxs(_,{sx:{p:{xs:2,sm:3},mt:3},children:[e.jsx(t,{variant:"h6",gutterBottom:!0,children:"Measurement Results"}),e.jsx(p,{sx:{width:"100%",overflowX:"auto"},children:e.jsx(ee,{measurements:f.length>0?f:null,target:w,height:300,width:window.innerWidth<600?window.innerWidth-50:700})}),f.length>0&&e.jsx(ue,{measurements:f})]})]})},pt=({performMeasurement:s,isLoading:r,allMeasurements:i,currentTarget:c})=>e.jsxs(p,{children:[e.jsx(t,{variant:"h6",children:"REIG Calculation"}),e.jsxs(_,{sx:{p:{xs:2,sm:3},mt:2},children:[e.jsx(t,{gutterBottom:!0,children:"Real Ear Insertion Gain (REIG) is calculated as the difference between REAR and REUR. This shows the actual gain provided by the hearing aid in the patient's ear."}),e.jsx(L,{variant:"contained",color:"primary",onClick:s,disabled:r,sx:{mt:2},children:r?e.jsxs(e.Fragment,{children:[e.jsx(ve,{size:24,sx:{mr:1}}),"Calculating..."]}):"Calculate REIG"}),e.jsx(p,{sx:{mt:3,width:"100%",overflowX:"auto"},children:e.jsx(ee,{measurements:i.length>0?i:null,target:c,height:300,width:window.innerWidth<600?window.innerWidth-50:700})}),i.length>0&&e.jsx(ue,{measurements:i})]})]}),gt=({prescriptionMethod:s,setPrescriptionMethod:r,generateTargets:i,allMeasurements:c,currentTarget:d})=>{const g=l=>{r(l.target.value)};return e.jsxs(p,{children:[e.jsx(t,{variant:"h6",children:"Compare to Target"}),e.jsxs(_,{sx:{p:{xs:2,sm:3},mt:2},children:[e.jsxs(v,{container:!0,spacing:3,children:[e.jsxs(v,{item:!0,xs:12,md:6,children:[e.jsxs(I,{fullWidth:!0,sx:{mb:2},children:[e.jsx(O,{children:"Prescription Method"}),e.jsxs(D,{value:s,onChange:g,label:"Prescription Method",children:[e.jsx(y,{value:"NAL-NL2",children:"NAL-NL2"}),e.jsx(y,{value:"DSL",children:"DSL v5.0"}),e.jsx(y,{value:"NAL-NL1",children:"NAL-NL1"}),e.jsx(y,{value:"custom",children:"Custom"})]})]}),e.jsx(L,{variant:"contained",color:"primary",onClick:i,sx:{mt:1},children:"Generate Targets"})]}),e.jsxs(v,{item:!0,xs:12,md:6,children:[e.jsxs(t,{variant:"subtitle1",gutterBottom:!0,children:["About ",s]}),e.jsxs(p,{sx:{p:2,bgcolor:"background.paper",borderRadius:1},children:[s==="NAL-NL2"&&e.jsx(t,{variant:"body2",children:"NAL-NL2 is the second-generation nonlinear prescription procedure from NAL. It aims to maximize speech intelligibility while maintaining comfortable loudness."}),s==="DSL"&&e.jsx(t,{variant:"body2",children:"DSL v5.0 is designed to provide audibility of speech across a wide range of inputs, with special considerations for pediatric fittings."}),s==="NAL-NL1"&&e.jsx(t,{variant:"body2",children:"NAL-NL1 is the first-generation nonlinear prescription procedure from NAL. It focuses on speech intelligibility with less emphasis on loudness normalization."}),s==="custom"&&e.jsx(t,{variant:"body2",children:"Custom targets allow for manual specification of desired gain at each frequency. This is useful for experienced clinicians with specific fitting goals."})]})]})]}),e.jsx(p,{sx:{mt:3,width:"100%",overflowX:"auto"},children:e.jsx(ee,{measurements:c.length>0?c:null,target:d,height:300,width:window.innerWidth<600?window.innerWidth-50:700})}),c.length>0&&e.jsx(ue,{measurements:c})]})]})},jt=({adjustedREAR:s,allMeasurements:r,currentTarget:i,session:c,matchAccuracy:d,adjustmentFeedback:g,adjustGainAtFrequency:l,checkTargetMatch:u,resetAdjustments:x,setSuccess:m,setSession:a})=>{const n=c?.targets.find(h=>h.type==="REIG")||null;return e.jsxs(p,{children:[e.jsx(t,{variant:"h6",children:"Adjust Frequency Response"}),e.jsxs(_,{sx:{p:{xs:2,sm:3},mt:2},children:[e.jsx(t,{gutterBottom:!0,children:"Adjust the REAR response to match the target by using the up and down buttons for each frequency. These adjustments simulate the process of fine-tuning a hearing aid's frequency response."}),e.jsx(S,{severity:"info",sx:{mb:2},children:"You should adjust the REAR response to match the REAR target (dotted line). This represents the ideal response needed to achieve the prescribed amplification for the patient."}),e.jsx(p,{sx:{mt:3,width:"100%",overflowX:"auto"},children:e.jsx(ee,{measurements:s?[...r.filter(h=>h.type!=="REAR"),s]:r,target:n||i,height:300,width:window.innerWidth<600?window.innerWidth-50:700})}),e.jsx(t,{variant:"subtitle1",sx:{mt:3,mb:2},children:"Adjust Gain at Each Frequency (dB)"}),e.jsx(p,{sx:{display:"grid",gridTemplateColumns:{xs:"repeat(3, 1fr)",sm:"repeat(4, 1fr)",md:"repeat(6, 1fr)",lg:"repeat(11, 1fr)"},gap:2,mb:3},children:ht.map(h=>{const f=s?.measurementPoints.find(w=>w.frequency===h)?.gain||0;return e.jsxs(p,{sx:{textAlign:"center"},children:[e.jsxs(t,{variant:"body2",fontWeight:"bold",children:[h," Hz"]}),e.jsxs(p,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(he,{size:"small",color:"primary",onClick:()=>l(h,1),children:e.jsx(p,{sx:{fontSize:"1.5rem"},children:"↑"})}),e.jsx(t,{variant:"body1",fontWeight:"bold",children:f.toFixed(1)}),e.jsx(he,{size:"small",color:"primary",onClick:()=>l(h,-1),children:e.jsx(p,{sx:{fontSize:"1.5rem"},children:"↓"})})]})]},h)})}),e.jsxs(p,{sx:{display:"flex",gap:2,mt:3,flexWrap:"wrap"},children:[e.jsx(L,{variant:"contained",color:"primary",onClick:u,disabled:!s,children:"Check Target Match"}),e.jsx(L,{variant:"outlined",onClick:x,disabled:!s,children:"Reset Adjustments"}),d!==null&&e.jsx(L,{variant:"contained",color:"success",onClick:()=>{if(m("REM procedure completed successfully!"),c){const h=[...r.filter(w=>w.type!=="REAR")];s&&h.push(s);const f={...c,completed:!0,measurements:h,accuracy:d||0};a(f)}},children:"Complete REM Procedure"})]}),g&&e.jsxs(S,{severity:d&&d>=80?"success":d&&d>=70?"info":"warning",sx:{mt:3},children:[g,d!==null&&e.jsxs(t,{variant:"body2",sx:{mt:1},children:["Accuracy score: ",d.toFixed(1),"%"]})]}),e.jsxs(S,{severity:"info",sx:{mt:3},children:[e.jsx(t,{variant:"subtitle2",children:"Clinical best practices for target matching:"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Speech frequencies (1000-4000 Hz) should be within ±3 dB of target"}),e.jsx("li",{children:"Low frequencies (125-750 Hz) should be within ±5 dB of target"}),e.jsx("li",{children:"High frequencies (6000-8000 Hz) should be within ±8 dB of target"}),e.jsx("li",{children:"Overall RMS difference should be less than 5 dB for an optimal fit"})]})]})]})]})},ft=s=>{const{activeStep:r}=s;switch(r){case 0:return e.jsx(ut,{...s});case 1:return e.jsx(xt,{...s});case 2:case 3:case 4:return e.jsx(mt,{...s});case 5:return e.jsx(pt,{...s});case 6:return e.jsx(gt,{...s});case 7:return e.jsx(jt,{...s});default:return null}},bt=()=>e.jsxs(p,{sx:{p:3},children:[e.jsx(t,{variant:"h5",gutterBottom:!0,children:"Real Ear Measurement Tutorial"}),e.jsx(t,{variant:"h6",sx:{mt:3},children:"What is Real Ear Measurement?"}),e.jsx(t,{paragraph:!0,children:"Real Ear Measurement (REM) is a verification procedure used to measure the performance of hearing aids in an individual's ear. It helps ensure that the hearing aid is providing the appropriate amount of amplification across frequencies based on the patient's hearing loss."}),e.jsx(t,{variant:"h6",sx:{mt:3},children:"Types of REM Measurements"}),e.jsxs(v,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(v,{item:!0,xs:12,md:6,children:e.jsx(C,{children:e.jsxs(T,{children:[e.jsx(t,{variant:"subtitle1",color:"primary",children:"REUR"}),e.jsx(t,{variant:"body2",children:"Real Ear Unaided Response - Measures the natural acoustic response of the ear canal without a hearing aid. This shows the natural resonance of the ear canal."})]})})}),e.jsx(v,{item:!0,xs:12,md:6,children:e.jsx(C,{children:e.jsxs(T,{children:[e.jsx(t,{variant:"subtitle1",color:"primary",children:"REOR"}),e.jsx(t,{variant:"body2",children:"Real Ear Occluded Response - Measures the response with the hearing aid in place but turned off. Shows the impact of blocking the ear canal."})]})})}),e.jsx(v,{item:!0,xs:12,md:6,children:e.jsx(C,{children:e.jsxs(T,{children:[e.jsx(t,{variant:"subtitle1",color:"primary",children:"REAR"}),e.jsx(t,{variant:"body2",children:"Real Ear Aided Response - Measures the response with the hearing aid in place and turned on. This is the actual output of the hearing aid in the ear."})]})})}),e.jsx(v,{item:!0,xs:12,md:6,children:e.jsx(C,{children:e.jsxs(T,{children:[e.jsx(t,{variant:"subtitle1",color:"primary",children:"REIG"}),e.jsx(t,{variant:"body2",children:"Real Ear Insertion Gain - The difference between REAR and REUR, showing the actual gain provided by the hearing aid in the patient's ear."})]})})})]}),e.jsx(t,{variant:"h6",sx:{mt:3},children:"REM Procedure Steps"}),e.jsxs("ol",{children:[e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Setup the equipment:"})," Select the appropriate patient, hearing aid, and ear."]})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Position the probe tube:"})," Insert the probe tube to the correct depth in the ear canal, typically 25-28mm from the tragus for an adult."]})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Measure REUR:"})," Record the unaided response of the ear canal."]})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Insert hearing aid and measure REOR:"})," With the hearing aid in place but turned off."]})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Turn on hearing aid and measure REAR:"})," With the hearing aid providing amplification."]})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Calculate REIG:"})," Compare REAR to REUR to determine insertion gain."]})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Compare to targets:"})," Compare the measurements to prescriptive targets (NAL-NL2, DSL v5.0, etc.)."]})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Make adjustments:"})," Adjust the hearing aid settings to better match the targets if needed."]})})]}),e.jsx(Xe,{sx:{my:4}}),e.jsx(t,{variant:"h6",sx:{mt:3},children:"How to Instruct Patients"}),e.jsx(C,{sx:{mb:3},children:e.jsxs(T,{children:[e.jsx(t,{variant:"subtitle1",color:"primary",gutterBottom:!0,children:"Before the Procedure"}),e.jsxs("ul",{children:[e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Explain the purpose:"}),` "This test helps us make sure your hearing aids are providing the right amount of sound specifically for your ears. It's a quick, painless procedure that will help us get the best results from your hearing aids."`]})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Set expectations:"}),` "You'll feel me placing a thin, soft tube in your ear canal, followed by your hearing aid. You'll hear different sounds during the test. You don't need to respond to these sounds - just sit still and remain quiet."`]})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Position instructions:"}),' "Please sit facing forward and try not to move your head during the measurements. This helps us get accurate readings."']})})]})]})}),e.jsx(C,{sx:{mb:3},children:e.jsxs(T,{children:[e.jsx(t,{variant:"subtitle1",color:"primary",gutterBottom:!0,children:"During the Procedure"}),e.jsxs("ul",{children:[e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Provide ongoing guidance:"}),` "I'm going to place the tube in your ear now. You may feel a slight tickle, but it shouldn't be uncomfortable."`]})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Reassurance:"}),` "You're doing great. The test will take just a few more minutes."`]})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Movement reminders:"}),' "Please try to stay as still as possible while the measurement is running."']})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Silence during measurements:"}),` "I'll need you to remain quiet during the actual measurements. I'll let you know when each one starts and ends."`]})})]})]})}),e.jsx(C,{children:e.jsxs(T,{children:[e.jsx(t,{variant:"subtitle1",color:"primary",gutterBottom:!0,children:"After the Procedure"}),e.jsxs("ul",{children:[e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Explain the results:"}),' "These graphs show how your hearing aids are performing in your ears. The dotted line shows our target, and the solid line shows what your hearing aids are actually doing."']})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Address adjustments:"}),` "Based on these measurements, I'm going to make some fine-tuning adjustments to your hearing aids to better match your specific needs."`]})}),e.jsx("li",{children:e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"Encourage feedback:"}),' "After we make these adjustments, please let me know how things sound to you. Your subjective experience is also important."']})})]})]})}),e.jsx(t,{variant:"h6",sx:{mt:4},children:"Common Challenges and How to Overcome Them"}),e.jsxs(v,{container:!0,spacing:2,sx:{mt:1},children:[e.jsx(v,{item:!0,xs:12,md:6,children:e.jsx(C,{sx:{height:"100%"},children:e.jsxs(T,{children:[e.jsx(t,{variant:"subtitle1",color:"primary",children:"Challenge: Probe Tube Placement"}),e.jsx(t,{variant:"body2",paragraph:!0,children:"Incorrect probe tube placement is one of the most common sources of error."}),e.jsx(t,{variant:"subtitle2",children:"Solutions:"}),e.jsxs("ul",{children:[e.jsx("li",{children:e.jsx(t,{variant:"body2",children:"Mark the probe tube at appropriate depths (25-28mm adults, 20-22mm children)."})}),e.jsx("li",{children:e.jsx(t,{variant:"body2",children:"Use otoscopy before placement to understand individual ear canal anatomy."})}),e.jsx("li",{children:e.jsx(t,{variant:"body2",children:"Check placement with otoscopy after insertion when possible."})})]})]})})}),e.jsx(v,{item:!0,xs:12,md:6,children:e.jsx(C,{sx:{height:"100%"},children:e.jsxs(T,{children:[e.jsx(t,{variant:"subtitle1",color:"primary",children:"Challenge: Feedback"}),e.jsx(t,{variant:"body2",paragraph:!0,children:"Acoustic feedback during REAR measurements can disrupt results."}),e.jsx(t,{variant:"subtitle2",children:"Solutions:"}),e.jsxs("ul",{children:[e.jsx("li",{children:e.jsx(t,{variant:"body2",children:"Ensure proper hearing aid fit and seal before measurements."})}),e.jsx("li",{children:e.jsx(t,{variant:"body2",children:"Temporarily reduce gain in regions causing feedback, then estimate target match."})}),e.jsx("li",{children:e.jsx(t,{variant:"body2",children:"Consider using a larger dome or custom earmold if feedback persists."})}),e.jsx("li",{children:e.jsx(t,{variant:"body2",children:"Position the probe tube so it's not touching the hearing aid receiver."})})]})]})})})]}),e.jsx(t,{variant:"h6",sx:{mt:4},children:"Things to Avoid"}),e.jsxs(S,{severity:"warning",sx:{mb:2},children:[e.jsx(t,{variant:"subtitle1",children:"Never Force the Probe Tube"}),e.jsx(t,{variant:"body2",children:"If you encounter resistance, pull back slightly and try a different angle. Forcing can cause discomfort."})]}),e.jsxs(S,{severity:"warning",sx:{mb:2},children:[e.jsx(t,{variant:"subtitle1",children:"Don't Skip Otoscopy"}),e.jsx(t,{variant:"body2",children:"Always examine the ear canal before insertion to check for obstructions, irritation, or unusual anatomy."})]}),e.jsxs(S,{severity:"warning",sx:{mb:2},children:[e.jsx(t,{variant:"subtitle1",children:"Avoid Comparing Incompatible Measurements"}),e.jsx(t,{variant:"body2",children:"Make sure you're comparing the correct measurement types (e.g., REAR with REAR targets, not REIG targets)."})]}),e.jsxs(S,{severity:"warning",children:[e.jsx(t,{variant:"subtitle1",children:"Don't Rely Solely on REM"}),e.jsx(t,{variant:"body2",children:"While REM is crucial for verification, also consider patient subjective feedback to ensure comfort and satisfaction."})]})]}),yt=()=>e.jsxs(p,{sx:{p:3},children:[e.jsx(t,{variant:"h5",gutterBottom:!0,children:"Reference Materials"}),e.jsx(t,{variant:"h6",sx:{mt:3},children:"Prescription Methods"}),e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"NAL-NL2:"})," The National Acoustic Laboratories' nonlinear prescription, version 2. This formula aims to maximize speech intelligibility while maintaining comfortable loudness. It's widely used for adults with acquired hearing loss."]}),e.jsxs(t,{paragraph:!0,children:[e.jsx("strong",{children:"DSL v5.0:"})," Desired Sensation Level, version 5.0. This method focuses on audibility across a wide range of input levels and is commonly used for pediatric fittings."]}),e.jsx(C,{sx:{mb:4,mt:2},children:e.jsxs(T,{children:[e.jsx(t,{variant:"h6",color:"primary",gutterBottom:!0,children:"NAL-NL2 In-Depth"}),e.jsx(t,{variant:"subtitle1",sx:{mt:2},children:"Calculation Methodology"}),e.jsx(t,{variant:"body2",paragraph:!0,children:"NAL-NL2 uses a complex calculation process that considers multiple variables to generate prescriptive targets:"}),e.jsxs("ol",{children:[e.jsx("li",{children:e.jsxs(t,{variant:"body2",paragraph:!0,children:[e.jsx("strong",{children:"Loudness Normalization:"})," The fundamental principle is to maximize speech intelligibility while maintaining comfortable loudness across frequencies. NAL-NL2 aims to equalize loudness contributions from different frequency regions with importance weighted toward speech frequencies."]})}),e.jsx("li",{children:e.jsxs(t,{variant:"body2",paragraph:!0,children:[e.jsx("strong",{children:"Input Level Compensation:"})," NAL-NL2 applies different gain prescriptions based on input level (typically 50, 65, and 80 dB SPL). This creates a compression response that mimics normal loudness growth."]})}),e.jsx("li",{children:e.jsxs(t,{variant:"body2",paragraph:!0,children:[e.jsx("strong",{children:"Individual Factors Adjustment:"})," The formula includes corrections for:",e.jsxs("ul",{children:[e.jsx("li",{children:"Gender (typically more gain for males)"}),e.jsx("li",{children:"Age (reduced high-frequency gain for older adults)"}),e.jsx("li",{children:"Experience level (gradual increase in gain for new users)"}),e.jsx("li",{children:"Language background (tonal vs. non-tonal languages)"})]})]})}),e.jsx("li",{children:e.jsxs(t,{variant:"body2",paragraph:!0,children:[e.jsx("strong",{children:"Binaural Summation:"})," When fitting binaurally, NAL-NL2 reduces gain by approximately 2-3 dB compared to monaural fittings, accounting for binaural loudness summation."]})}),e.jsx("li",{children:e.jsxs(t,{variant:"body2",paragraph:!0,children:[e.jsx("strong",{children:"Severe-to-Profound Adaptation:"})," For severe and profound hearing losses, NAL-NL2 provides proportionally more gain in low and mid frequencies and less in high frequencies compared to moderate losses."]})})]})]})}),e.jsx(C,{sx:{mb:4},children:e.jsxs(T,{children:[e.jsx(t,{variant:"h6",color:"primary",gutterBottom:!0,children:"Comparison: NAL-NL2 vs. Manufacturer Formulas"}),e.jsx(t,{variant:"body2",paragraph:!0,children:"Manufacturer-specific fitting formulas often differ from NAL-NL2 in significant ways. Understanding these differences is crucial for clinical decision-making."}),e.jsx(t,{variant:"subtitle1",gutterBottom:!0,children:"Key Differences"}),e.jsxs(v,{container:!0,spacing:2,children:[e.jsx(v,{item:!0,xs:12,md:6,children:e.jsx(C,{variant:"outlined",sx:{height:"100%"},children:e.jsxs(T,{children:[e.jsx(t,{variant:"subtitle2",color:"primary",children:"Gain Differences"}),e.jsxs(t,{variant:"body2",paragraph:!0,children:[e.jsx("strong",{children:"NAL-NL2:"})," Typically prescribes less gain, especially in low frequencies. Targets highest gain in mid-frequencies where speech information is most important."]}),e.jsxs(t,{variant:"body2",paragraph:!0,children:[e.jsx("strong",{children:"Manufacturer Formulas:"}),' Often prescribe 3-8 dB more overall gain than NAL-NL2, particularly in low frequencies. This can make hearing aids sound "fuller" initially but may lead to issues with occlusion and user comfort.']})]})})}),e.jsx(v,{item:!0,xs:12,md:6,children:e.jsx(C,{variant:"outlined",sx:{height:"100%"},children:e.jsxs(T,{children:[e.jsx(t,{variant:"subtitle2",color:"primary",children:"Compression Characteristics"}),e.jsxs(t,{variant:"body2",paragraph:!0,children:[e.jsx("strong",{children:"NAL-NL2:"})," Uses moderate compression ratios tailored to hearing loss severity. Focuses on maintaining speech intelligibility."]}),e.jsxs(t,{variant:"body2",paragraph:!0,children:[e.jsx("strong",{children:"Manufacturer Formulas:"}),' May implement more aggressive compression, especially in proprietary "comfort" programs. Some formulas use frequency-specific compression ratios that differ substantially from research-based approaches.']})]})})})]})]})}),e.jsx(t,{variant:"h6",sx:{mt:3},children:"Proper Probe Tube Placement"}),e.jsx(t,{paragraph:!0,children:"For accurate measurements, the probe tube should be placed within 5-6mm of the tympanic membrane. For average adults, this is approximately 25-28mm from the tragus. Placement that is too shallow will result in inaccurate high-frequency measurements."}),e.jsx(t,{variant:"h6",sx:{mt:3},children:"Common Issues and Troubleshooting"}),e.jsxs(p,{sx:{mt:1},children:[e.jsxs(S,{severity:"warning",sx:{mb:2},children:[e.jsx(t,{variant:"subtitle2",children:"Feedback during measurement"}),e.jsx(t,{variant:"body2",children:"If feedback occurs, check that the hearing aid is properly sealed in the ear canal and that gain settings are appropriate for the patient's hearing loss."})]}),e.jsxs(S,{severity:"warning",sx:{mb:2},children:[e.jsx(t,{variant:"subtitle2",children:"Probe tube movement"}),e.jsx(t,{variant:"body2",children:"If the probe tube moves during measurements, results will be inconsistent. Ensure the tube is securely placed and minimize patient movement."})]}),e.jsxs(S,{severity:"warning",sx:{mb:2},children:[e.jsx(t,{variant:"subtitle2",children:"Poor match to targets"}),e.jsxs(t,{variant:"body2",children:["If measurements don't match targets despite adjustments, consider:",e.jsxs("ul",{children:[e.jsx("li",{children:"Different hearing aid style or model"}),e.jsx("li",{children:"Acoustic modifications (vent size, dome type)"}),e.jsx("li",{children:"Different prescription method"})]})]})]})]})]}),wt=()=>{const[s,r]=j.useState(null),[i,c]=j.useState(null),[d,g]=j.useState(0),[l,u]=j.useState(0),[x,m]=j.useState(!1),[a,n]=j.useState(null),[h,f]=j.useState(null),[w,W]=j.useState(""),[U,te]=j.useState(""),[se,re]=j.useState([]),[q,M]=j.useState("right"),[B,V]=j.useState(15),[ie,$]=j.useState(E.NOT_INSERTED),[G,Y]=j.useState("pure_tone_sweep"),[ne,Re]=j.useState(65),[Ee,xe]=j.useState(null),[ae,Se]=j.useState([]),[me,oe]=j.useState(null),[we,pe]=j.useState(!1),[N,k]=j.useState("REUR"),[X,Ce]=j.useState("NAL-NL2"),[H,Te]=j.useState(A.OCCLUDED),[F,ge]=j.useState(null),[Ae,le]=j.useState(null),[Le,z]=j.useState(null);j.useEffect(()=>{const o=new ct;return r(o),re(o.getHearingAids()),()=>{o.dispose()}},[]),j.useEffect(()=>{l===7&&!F&&J()},[l,F]),j.useEffect(()=>{if(s&&i&&N==="REOR"&&i.ventType!==H){const o={...i,ventType:H};c(o)}},[H,s,i,N]);const Ne=()=>{if(s&&w&&U){const o=s.createSession(w,U);c(o),u(0),n(null),f(null),$(E.NOT_INSERTED),xe(null),oe(null),f("Session initialized. Proceed to position the probe tube.")}else n("Please select a patient and hearing aid to continue")},Pe=()=>{if(s)try{const o=s.positionProbeTube(B);$(o),o===E.CORRECT?(f("Probe tube correctly positioned"),n(null)):o===E.TOO_SHALLOW?(n("Probe tube is too shallow - adjust depth"),f(null)):o===E.TOO_DEEP&&(n("Probe tube is too deep - adjust depth"),f(null))}catch(o){n(o instanceof Error?o.message:"An unknown error occurred"),f(null)}},Me=async()=>{if(!(!s||!i)){m(!0),n(null);try{if(N==="REOR"){const Q={...i,ventType:H};c(Q)}const o=await s.performMeasurement(N,q,G,ne),b=[...i.measurements.filter(Q=>Q.type!==N),o],R={...i,measurements:b,currentStep:N};Se(b),xe(o),c(R),f(`${N} measurement completed successfully`),l>=2&&l<=4&&(u(l+1),l===2?k("REOR"):l===3?k("REAR"):l===4&&k("REIG"))}catch(o){n(o instanceof Error?o.message:"An unknown error occurred during measurement")}finally{m(!1)}}},ke=()=>{if(s&&w)try{const o=s.generateTargets(w,X);if(o.length>0){const b=o.find(R=>R.type===N);b?(oe(b),f(`Generated ${X} targets for ${N}`)):(oe(o[0]),f(`Generated ${X} targets`))}}catch(o){n(o instanceof Error?o.message:"An unknown error occurred")}},Ie=()=>{s&&(s.playTestSignal(G,ne,q),pe(!0))},Oe=()=>{s&&(s.stopTestSignal(),pe(!1))},J=()=>{if(ae.length>0){const o=ae.find(b=>b.type==="REAR");if(o){const b={...o,type:"REAR",timestamp:new Date().toISOString(),measurementPoints:[...o.measurementPoints.map(R=>({...R}))]};return ge(b),b}}return null},De=(o,b)=>{!F&&!J()||ge(R=>R?{...R,measurementPoints:R.measurementPoints.map(K=>K.frequency===o?{...K,gain:Math.max(0,Math.min(80,K.gain+b))}:K),timestamp:new Date().toISOString()}:null)},_e=()=>{if(s&&F&&i){let o=me;const b=i.targets.find(R=>R.type==="REIG");if(b&&(o=b),o){const R=s.calculateAccuracy(F,o);le(R),R>=90?(z("Excellent match! The adjustments are within clinical standards."),f("Target match successful!")):R>=80?z("Good match, but some frequencies could be adjusted further for optimal results."):R>=70?z("Acceptable match, but consider further adjustments, especially in the speech frequencies (1000-4000 Hz)."):z("Poor match to target. Significant adjustments are needed across multiple frequencies.")}}},Be=()=>{J(),le(null),z(null)},Ge=()=>{u(o=>{const b=o+1;return b===2?k("REUR"):b===3?k("REOR"):b===4?k("REAR"):b===5?k("REIG"):b===7&&(le(null),z(null),J()),b})},Fe=()=>{u(o=>o-1)},ze=(o,b)=>{g(b)};return e.jsx(Je,{maxWidth:"lg",sx:{mt:4,mb:8},children:e.jsxs(_,{sx:{p:{xs:2,sm:3}},children:[e.jsxs(p,{sx:{display:"flex",flexDirection:{xs:"column",sm:"row"},alignItems:{xs:"flex-start",sm:"center"},mb:2},children:[e.jsx(Qe,{sx:{fontSize:40,mr:{xs:0,sm:2},mb:{xs:1,sm:0},color:"primary.main"}}),e.jsx(t,{variant:"h4",component:"h1",sx:{fontSize:{xs:"1.75rem",sm:"2.125rem"}},children:"Real Ear Measurement Practice"})]}),e.jsxs(Ke,{value:d,onChange:ze,sx:{mb:3},children:[e.jsx(ce,{label:"Practice"}),e.jsx(ce,{label:"Tutorial"}),e.jsx(ce,{label:"Reference"})]}),a&&e.jsx(S,{severity:"error",sx:{mb:2},children:a}),h&&e.jsx(S,{severity:"success",sx:{mb:2},children:h}),d===0&&e.jsxs(e.Fragment,{children:[e.jsx(p,{sx:{display:{xs:"none",md:"block"},mb:4},children:e.jsx(je,{activeStep:l,children:de.map(o=>e.jsx(fe,{children:e.jsx(be,{children:o})},o))})}),e.jsx(p,{sx:{display:{xs:"block",md:"none"},mb:4},children:e.jsx(je,{activeStep:l,orientation:"vertical",children:de.map(o=>e.jsx(fe,{children:e.jsx(be,{children:o})},o))})}),e.jsx(ft,{activeStep:l,remService:s,session:i,selectedPatient:w,setSelectedPatient:W,selectedHearingAid:U,setSelectedHearingAid:te,hearingAids:se,selectedEar:q,setSelectedEar:M,probeTubeDepth:B,setProbeTubeDepth:V,probePosition:ie,signalType:G,setSignalType:Y,inputLevel:ne,setInputLevel:Re,currentMeasurement:Ee,allMeasurements:ae,currentTarget:me,isPlaying:we,measurementType:N,setMeasurementType:k,prescriptionMethod:X,setPrescriptionMethod:Ce,selectedVentType:H,setSelectedVentType:Te,adjustedREAR:F,matchAccuracy:Ae,adjustmentFeedback:Le,isLoading:x,startNewSession:Ne,handlePositionProbeTube:Pe,performMeasurement:Me,playTestSignal:Ie,stopTestSignal:Oe,generateTargets:ke,adjustGainAtFrequency:De,checkTargetMatch:_e,resetAdjustments:Be,setSuccess:f,setSession:c}),e.jsxs(p,{sx:{display:"flex",justifyContent:"space-between",mt:4},children:[e.jsx(L,{variant:"outlined",disabled:l===0,onClick:Fe,children:"Back"}),e.jsx(L,{variant:"contained",color:"primary",onClick:Ge,disabled:l===0&&!i||l===1&&ie!==E.CORRECT||x,children:l===de.length-1?"Finish":"Next"})]})]}),d===1&&e.jsx(bt,{}),d===2&&e.jsx(yt,{})]})})};export{wt as default};
